#!/usr/bin/python

from __future__ import print_function

import ast
import urllib2
import re
import os
import sys
import apt_pkg
import shlex

from operator import itemgetter
from optparse import OptionParser
from functools import cmp_to_key

parser = OptionParser()
parser.add_option("-v", "--versions", type="int", help="Number of versions to show in the matrix")

(options, args) = parser.parse_args()

#url = 'http://jenkins.qa.ubuntu.com/view/DKMS/view/U%20-generic'
#url = 'http://jenkins.qa.ubuntu.com/view/DKMS/view/T%20Proposed%20-generic/'

apt_pkg.init_system()

packages = {}
groups = []
for line in sys.stdin:
    a = shlex.split(line.strip())
    (link, group, urls) = (a[0], a[1], a[2:])

    versions = {}
    jobs = {}
    links = {}
    for url in urls:
        tree = ast.literal_eval(urllib2.urlopen(url + '/api/python?depth=2').read().decode('utf-8'))

        for job in tree['jobs']:
            #print(job['name'], file=sys.stderr)
            #print(job['description'], file=sys.stderr)
            name = job['name'].split('-').pop()

            #print(job['builds'][0])
            seen = False
            # Ensure we treat runs in latest build in the latest kernel first order.
            for build in sorted(job['builds'], key=itemgetter('number', 'timestamp')):
                #print(build['description'], file=sys.stderr)
                if 'description' not in build or not build['description']:
                    continue
                (kver, pver) = build['description'].split(' ')
                if '-' not in kver:
                    continue
                (pkg, pver) = pver.split('/')
                if pkg == '':
                    continue

                if build['result'] == 'SUCCESS':
                    status = 'GOOD'
                elif build['result'] == None:
                    status = 'RUN'
                else:
                    status = 'FAIL'

                ##print(name, kver, pver, status)
                packages[name] = True
                versions[kver] = True
                jobs[name, kver] = status
                links[name, kver] = build['url']

    vlist = sorted(versions.keys(), key=cmp_to_key(apt_pkg.version_compare))
    if options.versions:
        vlist = vlist[-options.versions:]
    groups.append((group, link, vlist, jobs, links))

packages = sorted(packages)

print("""<html>
<head>
<title>DKMS Matrix</title>
<style>
.GOOD { background-color: green; }
.RUN { background-color: yellow; }
.FAIL { background-color: orange; }
.REGR { background-color: red; }
table.matrix {
    border-collapse: collapse;
}
table.matrix, table.matrix th, table.matrix td {
   border: 1px solid black;
} 
</style>
</head>
<body>
<h1>DKMS Matrix</h1>
<table class="matrix">
""")

print("<tr><th>")
cols = []
for (group, link, vlist, jobs, links) in groups:
    cols.append('<th colspan="{0}"><a href="{1}">{2}</a>'.format(str(len(vlist)), link, group))
print("<th>&nbsp;".join(cols))
print("<th></tr>")
    
print("<tr><th>")
cols = []
for (group, link, vlist, jobs, links) in groups:
    grp = ''
    for version in vlist:
        grp += "<th>" + version
    cols.append(grp)
print("<th>&nbsp;".join(cols))
print("<th></tr>")

hclass = {
    ('GOOD', 'FAIL'): 'REGR'
}

for package in sorted(packages):
    print("<tr><th>" + package)
    (pstatus, status) = ("&nbsp;", "&nbsp;")
    cols = []
    for (group, link, vlist, jobs, links) in groups:
        grp = ''
        for version in vlist:
            (pstatus, status) = (status if status != "&nbsp;" else pstatus, jobs.get((package, version), "&nbsp;"))

            if (package, version) in links:
                 fmt = '<td class="{0}"><a href="{1}">{2}</a>'
            else:
                 fmt = '<td class="{0}">{2}'
            grp += fmt.format(hclass.get((pstatus, status), status), links.get((package, version), ''), status)
        cols.append(grp)
    print("<th>&nbsp;".join(cols))
    print("<th>" + package + "</tr>")

print("""</table>
</body>
</html>""")
