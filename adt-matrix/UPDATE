#!/bin/bash

here=`dirname $0`
case "$here" in
/*) ;;
*)  here="`pwd`/$here" ;;
esac

if [ "$#" -ne 1 ]; then
	echo "Usage: $0 <britney state directory>" 1>&2
fi

britney="$1"

# Update package-relation.json
[ ! -f package-relation.json ] && \
	cp "$here/package-relation.json-initial" package-relation.json
while read series package parent
do
	echo "$series $package $parent $britney/$series.migration"
done <"$here/adt-matrix.conf" | \
	"$here/adt-seed-accumulate"

cmds="cmds.rebuild"
: >"$cmds"
while read series package parent
do
	[ "$series" = '#' ] && continue

        version=`"$here/../cve-tools/cves-kernel-versions" "proposed" "$series" "$package"`
	echo "$series $package $version" 1>&2

	case "$package" in
	linux-meta*)
		migration=`awk '/^'"$series $package"' / { state=$NF} END {print state }' "$britney/overall.txt"`
		[ "$migration" = '' ] && migration="MIGRATED"

		package2=`echo "$package" | sed -e 's/^linux-meta/linux/'`
		version2=`"$here/../cve-tools/cves-kernel-versions" "proposed" "$series" "$package2"`
		echo "$series $package2 $version2" 1>&2

		echo "$series" "$package/$version" "$package2/$version2" "$series-$package.cmds" >>"$cmds"
		#"$here/adt-commands-payload" "$series" "$package/$version" "$package2/$version2" >"$series-$package.cmds.new"
		#mv -f "$series-$package.cmds.new" "$series-$package.cmds"
		;;
	*)
		migration="-"
		;;
	esac
	echo "$series $package $parent $version $migration"
done <"$here/adt-matrix.conf" | \
	"$here/adt-matrix"

while read series trigger1 trigger2 output
do
	echo "commands: $series $trigger1 $trigger2 $output"
	"$here/adt-commands-payload" "$series" "$trigger1" "$trigger2" >"$output.new"
	mv -f "$output.new" "$output"
done <"$cmds"
