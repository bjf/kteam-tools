#!/bin/bash

here=`dirname $0`
case "$here" in
/*) ;;
*)  here="`pwd`/$here" ;;
esac

if [ "$#" != 3 ]; then
	echo "Usage: $0 <html> <britney cache> <hints git repo>" 1>&2
	exit 1
fi
html="$1"
britney="$2"
git="$3"

hints="$here/hints"
if [ ! -d "$hints" ]; then
	git clone "$git" "$hints"
else
	(cd "$hints" && git checkout -f && git pull)
fi

mkdir -p "$html"
(
	cd "$html" || exit 1
	echo
	"$here/adt-update" "$hints/primary.conf" "$hints/primary.hints" - "$britney"
)

for conf in "$hints/"/*.conf
do
	handle=$( basename "$conf" .conf )
	[ "$handle" = "primary" ] && continue
	archive=$( echo "$handle" | sed -e 's@--@/@g' )
	(
		mkdir -p "$html/$handle"
		cd "$html/$handle" || exit 1

		ln -sf ../package-relation.json .

		"$here/adt-update" \
			"$hints/$handle.conf" \
			"$hints/$handle.hints" \
			"$archive" -
	)
done

"$here/adt-cleanup"
