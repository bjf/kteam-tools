#!/bin/bash

here=`dirname $0`
case "$here" in
/*) ;;
*)  here="`pwd`/$here" ;;
esac

if [ "$#" -ne 1 ]; then
	echo "Usage: $0 <britney state directory>" 1>&2
fi

britney="$1"

# Update package-relation.json
[ ! -f package-relation.json ] && \
	cp "$here/package-relation.json-initial" package-relation.json
while read series package parent
do
	echo "$series $package $parent $britney/$series.migration"
done <"$here/adt-matrix.conf" | \
	"$here/adt-seed-accumulate"

while read series package parent
do
	[ "$series" = '#' ] && continue

	case "$package" in
	linux-meta*)
		migration=`awk '/^'"$series $package"' / { state=$NF} END {print state }' "$britney/overall.txt"`
		[ "$migration" = '' ] && migration="MIGRATED"
		;;
	*)
		migration="-"
		;;
	esac
	echo "$series $package $parent $migration"
done <"$here/adt-matrix.conf" | \
	"$here/adt-matrix"

while read series package parent
do
	"$here/adt-commands" "$series-proposed" "$package"
done <"$here/adt-matrix.conf" >"rebuild.cmds.new"
mv -f "rebuild.cmds.new" "rebuild.cmds"
