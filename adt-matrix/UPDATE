#!/bin/bash

here=`dirname $0`
case "$here" in
/*) ;;
*)  here="`pwd`/$here" ;;
esac

if [ "$#" -ne 1 ]; then
	echo "Usage: $0 <britney state directory>" 1>&2
fi

britney="$1"

# Update package-relation.json
[ ! -f package-relation.json ] && \
	cp "$here/package-relation.json-initial" package-relation.json
while read series package parent
do
	echo "$series $package $parent $britney/$series.migration"
done <"$here/adt-matrix.conf" | \
	"$here/adt-seed-accumulate"

while read series package parent
do
	case "$package" in
	linux-meta*)
		package2=`echo "$package" | sed -e 's/^linux-meta/linux/'`
		;;
	*)
		package2=
		;;
	esac
	echo "$series proposed $series $package $parent -- $package $package2"
done <"$here/adt-matrix.conf" |\
	"$here/adt-lp-version-map" >"versions.info"

cmds="cmds.rebuild"
: >"$cmds"
while read series package parent triggers
do
	[ "$series" = '#' ] && continue

	echo "versions $series $package $parent $triggers" 1>&2

	case "$package" in
	linux-meta*)
		migration=`awk '/^'"$series $package"' / { state=$NF} END {print state }' "$britney/overall.txt"`
		[ "$migration" = '' ] && migration="MIGRATED"
		;;
	*)
		migration="-"
		;;
	esac
	echo "$series $package $parent $migration $triggers"
done <"versions.info" | \
	"$here/adt-matrix"

# Build the commands after the adt-matrix completes as we rely no its missing
# test information to be up to date.
while read series package parent triggers
do
	echo "commands $series $package $triggers"
	
	"$here/adt-commands-payload" "$series" $triggers >"$series-$package.cmds.new"
	mv -f "$series-$package.cmds.new" "$series-$package.cmds"
done <"versions.info"
