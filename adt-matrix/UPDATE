#!/bin/bash

here=`dirname $0`
case "$here" in
/*) ;;
*)  here="`pwd`/$here" ;;
esac

if [ "$#" != 3 ]; then
	echo "Usage: $0 <html> <britney cache> <hints git repo>" 1>&2
	exit 1
fi
html="$1"
britney="$2"
git="$3"

hints="$here/hints"
if [ -d "$hints" ]; then
	git clone "$git" "$hints"
else
	(cd "$hints" && git checkout -f && git pull)
fi

mkdir -p "$html"
(
	cd "$html" || exit 1
	"$here/adt-update" "$here/adt-matrix.conf" "$here/adt-matrix.hints" - "$britney"
)
mkdir -p "$html/canonical-kernel-team--unstable"

(
	cd "$html/canonical-kernel-team--unstable" || exit 1
	ln -sf ../package-relation.json .

	"$here/adt-update" \
		"$here/adt-matrix.conf.d/canonical-kernel-team--unstable.conf" \
		"$here/adt-matrix.conf.d/canonical-kernel-team--unstable.hints" \
		canonical-kernel-team/unstable -
)

"$here/adt-cleanup"
