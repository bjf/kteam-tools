#!/bin/bash

here=`dirname $0`
case "$here" in
/*) ;;
*)  here="`pwd`/$here" ;;
esac

out="$HOME/public_html/status/dashboard-helper/proposed-migration"
mkdir -p "$out"

timestamp()
{
	local url="$1"

	RET=`wget -q --server-response --spider "$url" 2>&1 | awk '/Last-Modified:/ { $1=""; print }'`
	RET=`date --date="$RET" +%s`
}

{
	while read name url pockets
	do
		file="$out/$name"
		outd="$out/$name"
		mkdir -p "$outd"

		# Get the file update_excuses.yaml iff it has changed.
		urlt="$url/update_excuses.yaml"
		fname=`basename "$urlt"`
		(cd "$outd" && wget -qN -nd "$urlt")
		if [ -f "$outd/$fname" ]; then
			ln -f "$outd/$fname" "$file.migration"
		fi

		# Look at the triggers for a base timestamp.
		stamp=0
		for pocket in $pockets
		do
			purl="http://ftpmaster.internal/ubuntu/dists/$pocket/Release"
			timestamp "$purl"
			[ "$RET" -gt "$stamp" ] && stamp="$RET"
		done

		echo "$name $file.migration $stamp"
	done <<EOL
precise http://people.canonical.com/~ubuntu-archive/proposed-migration/precise precise precise-updates precise-proposed
trusty http://people.canonical.com/~ubuntu-archive/proposed-migration/trusty trusty trusty-updates trusty-proposed
vivid http://people.canonical.com/~ubuntu-archive/proposed-migration/vivid vivid vivid-updates vivid-proposed
wily http://people.canonical.com/~ubuntu-archive/proposed-migration/wily wily wily-updates wily-proposed
xenial http://people.canonical.com/~ubuntu-archive/proposed-migration/xenial xenial xenial-updates xenial-proposed
yakkety http://people.canonical.com/~ubuntu-archive/proposed-migration/yakkety yakkety yakkety-updates yakkety-proposed
EOL
} | "$here/helper-proposed-migration-payload" "$out/regressions.txt.new" "$out/overall.txt.new" | \
    "$HOME/bin/dashboard-status-bulk" "proposed-watcher"

mv -f "$out/regressions.txt.new" "$out/regressions.txt"
mv -f "$out/overall.txt.new" "$out/overall.txt"
