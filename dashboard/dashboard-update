#!/bin/bash

out="$HOME/public_html/status"
state="$out/dashboard-state"

mkdir -p "$state"

now=`date +%s`
date=`date '+%d-%b-%Y %H:%M'`

let later="$now+100"

status="$out/dashboard"

{
	echo "dashboard Dashboard `hostname` Scheduled%sUpdate $now $later $later"
	while read file title host url
	do
		# Get this if we can ... ignore it, we will use the previous data.
		#wget -q -O "$state/$file.new" "$url" && mv "$state/$file.new" "$state/$file"

		if [ -f "$state/$file" ]; then
			while read -r line
			do
				echo "$file $title $host $line"
			done <"$state/$file"
		else
			echo "$file $title $host MISSING%sDASHBOARD $now -1 -1"
		fi
	done <"$0.conf"
} | {
	: >"$status.txt.new"
	last_title=''
	while read section title host tag time warning alert message
	do
		if [ "$warning$alert" = '--' ]; then
			delta='-'
			case "$time" in
			G)	mode="good" ;;
			W)	mode="warn" ;;
			A)	mode="alert" ;;
			*)	mode="warn" ;;
			esac
		else
			let delta="$now-$time"
			if [ "$delta" -gt "$alert" ]; then
				mode="alert"
			elif [ "$delta" -gt "$warning" ]; then
				mode="warn"
			else
				mode="good"
			fi
		fi

		echo "$section $tag $time $warning $alert"
		echo "$title $tag $host $delta $mode $message" >>"$status.txt.new"
	done
}

#
# Generate the HTML tables from the .txt status summary.
#
n=0
last_title=''
while read title tag host delta mode message
do
	let n="$n+1"

	if [ "$title" != "$last_title" ]; then
		let n="$n+3"
		last_title="$title"
	fi
done <"$status.txt.new"
total="$n"
let halfway="$total/2"

min_distance="$total"
min_where=0

n=0
last_title=''
while read title tag host delta mode message
do
	let n="$n+1"

	if [ "$title" != "$last_title" ]; then
		last_title="$title"

		# Poor mans abs()
		let distance="($n - $halfway) * ($n - $halfway)"

		if [ "$distance" -lt "$min_distance" ]; then
			min_distance="$distance"
			min_where="$title"
			echo "$title $distance $min_distance $min_where"
		fi
		let n="$n+3"
	fi
done <"$status.txt.new"

echo "$halfway $min_distance $min_where"

cat - <<EOL >"$status.html.new"
<html>
<head>
<meta http-equiv="refresh" content="60">
<title>Kernel Dashboard</title>
<style>
.good { background-color: green; }
.warn { background-color: yellow; }
.alert { background-color: red; }
table.columns td.columns {
  vertical-align: top;
}
table.status {
  border: 0px;
  border-collapse: collapse;
}
table.status tr.gap, table.status tr.gap td {
  border: 0px;
  padding-bottom: 1px;
}
table.status tr, table.status th, table.status td {
  border: 1px solid black;
}
</style>
<script>
function pageLoaded() {
    if (!Date.now) {
	Date.now = function() { return new Date().getTime(); }
    }
    now = Math.floor(Date.now() / 1000)
    if ((now - $now) > (300 + 60 + 30)) {
	    document.getElementById("dashboard").style.background = "red";
    }
}
</script>
</head>
<body onload="pageLoaded()">
<h1>Kernel Dashboard ($date)</h1>
<table width=100% class="columns"><td class="columns" width=50%>
<table width=100% class="status">
EOL
last_title=''
n=0
while read title tag host delta mode message
do
	let n="$n+1"
	if [ "$title" = "$min_where" ]; then
		echo "</table><td class=\"columns\" width=50%><table class=\"status\" width=100%>" >>"$status.html.new"
		last_title=''
		min_where=''
	fi

	title=`echo "$title" | sed -e 's/%s/ /g' -e 's/%p/%/g'`
	tag=`echo "$tag" | sed -e 's/%s/ /g' -e 's/%p/%/g'`
	
	if [ "$last_title" != "$title" ]; then
		if [ "$last_title" != "" ]; then
			echo "<tr class=\"gap\"><td >&nbsp;</tr>" >>"$status.html.new"
		fi
		last_title="$title"

		echo "<tr><th colspan=4>$title</tr>" >>"$status.html.new"
		echo "<tr><th>Tool<th>Host<th>Last<th>Notes</tr>" >>"$status.html.new"
	fi

	# Ensure we do not execute something other than a number.
	#let time="$time + 0"
	#time=`date --date=@$time '+%d-%b-%Y %H:%M'`

	if [ "$delta" != '-' ]; then
		let delta="$delta / 60"
		ext='m'
		if [ "$delta" -ge 60 ]; then
			let delta="$delta / 60"
			ext='h'

			if [ "$delta" -ge "24" ]; then
				let delta="$delta / 24"
				ext='d'
			fi
		fi
		delta="$delta$ext"
	fi
	echo "<tr id=\"$section\" class=\"$mode\"><td>$tag<td>$host<td>$delta<td>$message</tr>" >>"$status.html.new"
done <"$status.txt.new"

cat - <<EOL >>"$status.html.new"
</table>
</table>
</body>
</html>
EOL

mv -f "$status.html.new" "$status.html"
mv -f "$status.txt.new" "$status.txt"
