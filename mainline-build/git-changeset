#!/usr/bin/python3

import codecs
import hashlib
import json
import os
import sys
import textwrap
import urllib.request

sys.stdin = codecs.getreader("utf-8")(sys.stdin.detach())
sys.stdout = codecs.getwriter("utf-8")(sys.stdout.detach())

entries = []
def add_entry(entry):
    if entry and 'ignore' not in entry:
        if 'bugs' in entry:
            ids = ','.join(set(entry['bugs']))
        elif 'cves' in entry:
            ids = ','.join(set(entry['cves']))
        elif 'UBUNTU: Ubuntu-' in entry['subject']:
            ids = entry['subject'][8:]
        else:
            m = hashlib.md5()
            m.update(entry['subject'].encode('utf-8'))
            ids = m.hexdigest()
        entry['id'] = ids.replace('/', '-').replace(' ', '-')

        entries.append(entry)

# Suck up the git log output and extract the information we need.
entry = None
subject_wait = False
for line in sys.stdin:
    if line.startswith('commit '):
        add_entry(entry)
        entry = {}
        subject_wait = True
        entry['commit'] = line.split()[1]

    elif line.startswith('Author: '):
        bits = line.strip().split(maxsplit=1)
        entry['author'] = bits[1]

    elif subject_wait and line.startswith('    '):
        subject_wait = False
        entry['subject'] = line.strip()

    elif line.startswith('    BugLink: ') and 'launchpad.net' in line:
        bits = line.strip().split(maxsplit=1)
        bits = bits[1].split('/')
        entry.setdefault('bugs', []).append('LP#' + bits[-1])

    elif line.startswith('    CVE-'):
        entry.setdefault('cves', []).append(line.strip())

    elif line.startswith('    Ignore:'):
        entry['ignore'] = True

add_entry(entry)

##entries.reverse()

# Go through the entries and clear out authors for upstream commits.
current = ['None']
for entry in entries:
    ids = entry.get('id', 'None')
    commit = entry['commit']
    if ids == current:
        continue
    current = ids
    print(commit, ids, entry['subject'])
