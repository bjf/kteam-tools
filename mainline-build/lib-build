#
# lib-build -- helpers for triggers and build recipies
#
master_main="$HOME/COD"
master_tree="$master_main/linux"

master_state="$master_main/state"

#master_repo="/srv/kernel.ubuntu.com/git/ubuntu"
archive_repo="git://kernel.ubuntu.com/ubuntu-archive"
master_repo="git://kernel.ubuntu.com/ubuntu"

# Select the master tree, creating it if necessary.
master_tree_select()
{
	repo_select "$master_tree"
}

# Select a repo, make it if it does not exist, and init it in git
# in preparation for a repo_remote_update().
repo_select()
{
	# Build us a master tree if we do not have one.
	if [ ! -d "$1" ]; then
		echo "$P: creating primary build tree ..."
		mkdir -p "$1"
		cd "$1"
		git init
	else
		cd "$1"
	fi
}

# Map remote names to real URLs for use when remotes are missing.
repo_remote_url_set()
{
        local remote="$1"

        remote=${remote//./__dt__}
        remote=${remote//-/__mi__}
        remote=${remote//+/__pl__}

	eval url_${remote}='"$2"'
}

repo_remote_url()
{
        local remote="$1"

        remote=${remote//./__dt__}
        remote=${remote//-/__mi__}
        remote=${remote//+/__pl__}

	eval RET="\$url_${remote}"
}

#repo_remote_url_set	'linus'			'git://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux-2.6.git'
repo_remote_url_set	'linus'			'git://kernel.ubuntu.com/virgin/linux.git'
repo_remote_url_set	'2.6.32.y.33.z'		'git://kernel.ubuntu.com/smb/linux-2.6.32.y-drm33.z.git'
#repo_remote_url_set	'linux-stable'		'git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux-stable.git'
repo_remote_url_set	'linux-stable'		'git://kernel.ubuntu.com/virgin/linux-stable.git'
repo_remote_url_set	'ubuntu-stable'		'git://kernel.ubuntu.com/herton/linux-stable.git'
#repo_remote_url_set	'airlied--linux'	'git://people.freedesktop.org/~airlied/linux'
repo_remote_url_set	'airlied--linux'	'git://kernel.ubuntu.com/virgin/testing/airlied--linux.git'
#repo_remote_url_set	'drm-intel'		'git://anongit.freedesktop.org/drm-intel'
repo_remote_url_set	'drm-intel'		'git://kernel.ubuntu.com/virgin/testing/drm-intel.git'
#repo_remote_url_set	'debloat-testing'	'git://git.infradead.org/debloat-testing.git'
repo_remote_url_set	'debloat-testing'	'git://kernel.ubuntu.com/herton/debloat-testing.git'
repo_remote_url_set	'extended-stable'	'git://kernel.ubuntu.com/ubuntu/linux.git'

repo_remote_url_set	'crack'			'git://kernel.ubuntu.com/virgin/testing/crack.git'
repo_remote_url_set	'crack-push'		'git://kernel.ubuntu.com/virgin/testing/crack.git'

repo_remote_url_set	'stable-queue'		'git://git.kernel.org/pub/scm/linux/kernel/git/stable/stable-queue.git'
repo_remote_url_set	'stable-queue-3.2'	'git://git.kernel.org/pub/scm/linux/kernel/git/bwh/linux-3.2.y-queue.git'

repo_remote_url_set	'hardy'			'git://kernel.ubuntu.com/ubuntu-archive/ubuntu-hardy.git'
repo_remote_url_set	'hardy-meta'		'git://kernel.ubuntu.com/ubuntu-archive/ubuntu-hardy-meta.git'
repo_remote_url_set	'intrepid'		'git://kernel.ubuntu.com/ubuntu-archive/ubuntu-intrepid.git'
repo_remote_url_set	'intrepid-meta'		'git://kernel.ubuntu.com/ubuntu-archive/ubuntu-intrepid-meta.git'
repo_remote_url_set	'jaunty'		'git://kernel.ubuntu.com/ubuntu-archive/ubuntu-jaunty.git'
repo_remote_url_set	'jaunty-meta'		'git://kernel.ubuntu.com/ubuntu-archive/ubuntu-jaunty-meta.git'
repo_remote_url_set	'karmic'		'git://kernel.ubuntu.com/ubuntu-archive/ubuntu-karmic.git'
repo_remote_url_set	'karmic-meta'		'git://kernel.ubuntu.com/ubuntu-archive/ubuntu-karmic-meta.git'
repo_remote_url_set	'maverick'		'git://kernel.ubuntu.com/ubuntu-archive/ubuntu-maverick.git'
repo_remote_url_set	'maverick-meta'		'git://kernel.ubuntu.com/ubuntu-archive/ubuntu-maverick-meta.git'
repo_remote_url_set	'natty'			'git://kernel.ubuntu.com/ubuntu-archive/ubuntu-natty.git'
repo_remote_url_set	'natty-meta'		'git://kernel.ubuntu.com/ubuntu-archive/ubuntu-natty-meta.git'
repo_remote_url_set	'oneiric'		'git://kernel.ubuntu.com/ubuntu-archive/ubuntu-oneiric.git'
repo_remote_url_set	'oneiric-meta'		'git://kernel.ubuntu.com/ubuntu-archive/ubuntu-oneiric-meta.git'
repo_remote_url_set	'quantal'		'git://kernel.ubuntu.com/ubuntu-archive/ubuntu-quantal.git'
repo_remote_url_set	'quantal-meta'		'git://kernel.ubuntu.com/ubuntu-archive/ubuntu-quantal-meta.git'
repo_remote_url_set	'raring'		'git://kernel.ubuntu.com/ubuntu-archive/ubuntu-raring.git'
repo_remote_url_set	'raring-meta'		'git://kernel.ubuntu.com/ubuntu-archive/ubuntu-raring-meta.git'
repo_remote_url_set	'saucy'			'git://kernel.ubuntu.com/ubuntu-archive/ubuntu-saucy.git'
repo_remote_url_set	'saucy-meta'		'git://kernel.ubuntu.com/ubuntu-archive/ubuntu-saucy-meta.git'

repo_remote_url_set	'lucid'			'git://kernel.ubuntu.com/ubuntu/ubuntu-lucid.git'
repo_remote_url_set	'lucid-meta'		'git://kernel.ubuntu.com/ubuntu/ubuntu-lucid-meta.git'

#repo_remote_url_set	'precise'		'git://kernel.ubuntu.com/ubuntu/ubuntu-precise.git'
#repo_remote_url_set	'precise-meta'		'git://kernel.ubuntu.com/ubuntu/ubuntu-precise-meta.git'
#repo_remote_url_set	'trusty'		'git://kernel.ubuntu.com/ubuntu/ubuntu-trusty.git'
#repo_remote_url_set	'trusty-meta'		'git://kernel.ubuntu.com/ubuntu/ubuntu-trusty-meta.git'
#repo_remote_url_set	'utopic'		'git://kernel.ubuntu.com/ubuntu/ubuntu-utopic.git'
#repo_remote_url_set	'utopic-meta'		'git://kernel.ubuntu.com/ubuntu/ubuntu-utopic-meta.git'
#repo_remote_url_set	'vivid'			'git://kernel.ubuntu.com/ubuntu/ubuntu-vivid.git'
#repo_remote_url_set	'vivid-meta'		'git://kernel.ubuntu.com/ubuntu/ubuntu-vivid-meta.git'

repo_remote_url_set	'precise'		'git://git.launchpad.net/~ubuntu-kernel/ubuntu/+source/linux/+git/precise'
repo_remote_url_set	'precise-meta'		'git://git.launchpad.net/~ubuntu-kernel/ubuntu/+source/linux-meta/+git/precise'
repo_remote_url_set	'precise-lbm'		'git://git.launchpad.net/~ubuntu-kernel/ubuntu/+source/linux-backports-modules-3.2.0/+git/precise'
repo_remote_url_set	'trusty'		'git://git.launchpad.net/~ubuntu-kernel/ubuntu/+source/linux/+git/trusty'
repo_remote_url_set	'trusty-meta'		'git://git.launchpad.net/~ubuntu-kernel/ubuntu/+source/linux-meta/+git/trusty'
repo_remote_url_set	'utopic'		'git://git.launchpad.net/~ubuntu-kernel/ubuntu/+source/linux/+git/utopic'
repo_remote_url_set	'utopic-meta'		'git://git.launchpad.net/~ubuntu-kernel/ubuntu/+source/linux-meta/+git/utopic'
repo_remote_url_set	'vivid'			'git://git.launchpad.net/~ubuntu-kernel/ubuntu/+source/linux/+git/vivid'
repo_remote_url_set	'vivid-meta'		'git://git.launchpad.net/~ubuntu-kernel/ubuntu/+source/linux-meta/+git/vivid'
repo_remote_url_set	'wily'			'git://git.launchpad.net/~ubuntu-kernel/ubuntu/+source/linux/+git/wily'
repo_remote_url_set	'wily-meta'		'git://git.launchpad.net/~ubuntu-kernel/ubuntu/+source/linux-meta/+git/wily'

repo_remote_url_set	'unstable'		'git://git.launchpad.net/~ubuntu-kernel/ubuntu/+source/linux/+git/unstable'

# Update a specific remote to the latest available, if the remote is missing
# then add it using the urls above.
repo_remote_update_as()
{
	local remote="$1"
	local url="$2"
	local curr

	curr=`git config "remote.$remote.url" || true`
	if [ "$curr" != "$url" ]; then
		echo "$P: removing $remote remote ($curr) ..."
		git remote rm "$remote" || true
		curr=""
	fi
	if [ "$curr" = "" ]; then
		echo "$P: adding $remote remote ($url) ..."
		git remote add "$remote" "$url"
	fi
	echo "$P: fetching $remote remote ..."
	git fetch "$remote" "+refs/heads/*:refs/remotes/$remote/*" '+refs/tags/*:refs/tags/*' || true
}

repo_remote_update()
{
	local remote="$1"
	local url
	
	repo_remote_url "$remote"; url="$RET"

	repo_remote_update_as "$remote" "$url"
}

repo_remote_update_list()
{
	local remote

	for remote in "$@"
	do
		repo_remote_update "$remote"
	done
}

#
# Add and update the upstream repositories as needed.
#
repo_update_ubuntu()
{
	local repo="$1"
	local series="$2"
	local url

	(
		repo_select "$master_main/$repo"
		remote=`echo "$repo" | sed -e "s/linux/$series/"`
		repo_remote_url "$remote"; url="$RET"

		repo_remote_update_as "$series" "$url"
	)
}
