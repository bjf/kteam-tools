#!/bin/bash

if [ "$#" -lt 2 ]; then
	echo "Usage: $0 <lockfile> <cmd> ..." 1>&2
	exit 1
fi
lock="$1"

mkdir -p $(dirname "$lock")

[ "${FLOCKER}" != "$lock" ] && exec env FLOCKER="$lock" flock -en "$lock" "$0" "$@" || :
shift

[ -f "$lock-done" ] && exit 0

"$@" || exit 1

touch "$lock-done"
exit 0
