#!/usr/bin/python3

import argparse
import copy
import os
import stat
import sys
import json
import tempfile
import yaml


def json_dumper(data, path):
    path = os.path.join(out, path)
    #print("PATH", path)
    os.makedirs(os.path.dirname(path), exist_ok=True)
    with open(path, "w") as wfd:
        json.dump(data, fp=wfd)

parser = argparse.ArgumentParser(description='Convert kernel-series.yaml to split json form.')
parser.add_argument('input', help="Path to kernel-series.yaml")
parser.add_argument('output', help="Path to split json directory")
args = parser.parse_args()

ks_file = args.input
out = args.output
os.makedirs(out, exist_ok=True)

# Make us a version directory to hold sub-components.
version_dir = tempfile.mkdtemp(dir=out, prefix='', suffix='')
os.chmod(version_dir, stat.S_IRWXU|stat.S_IRGRP|stat.S_IXGRP|stat.S_IROTH|stat.S_IXOTH)
version = version_dir.split('/')[-1]

with open(ks_file) as kfd:
    raw = yaml.safe_load(kfd)

routing_rest = None
top_rest = {}

for series_name, series_data in raw.items():
    if series_name == 'defaults':
        continue
    series_codename = series_data['codename']

    # XXX: we assume there is only one of these ... check?
    if routing_rest is None and 'routing-table' in series_data:
        routing_rest = series_data['routing-table']

    series_rest = copy.deepcopy(series_data)
    if 'sources' in series_rest:
        # For supported series include the supported status of the 'sources'.
        if True: #series_rest.get('supported', False) or series_rest.get('development', False):
            for source_name, source_data in series_data['sources'].items():
                data = {
                    '__l': "{}/{}/sources.json".format(version, series_codename),
                    '__k': source_name,
                    'supported': source_data.get('supported'),
                    'development': source_data.get('development')}
                series_rest['sources'][source_name] = data
        else:
            series_rest['sources'] = {
                    '__l': "{}/{}/sources.json".format(version, series_codename)}

    # Drop the routing-table data -- it is duplicated into each
    # and every series.
    if 'routing-table' in series_rest:
        del series_rest['routing-table']
        series_rest['routing-table'] = {'__l': "{}/routing-table.json".format(version)}

    series_rest['name'] = series_name
    # Accumulate the series set.
    top_rest[series_name] = series_rest

    # Dump the full sources list.
    if 'sources' in series_data:
        json_dumper(series_data['sources'], os.path.join(version, series_codename, "sources.json"))

json_dumper(routing_rest, os.path.join(version, "routing-table.json"))
json_dumper(top_rest, "kernel-series.json.new")
top = os.path.join(out, "kernel-series.json")
os.rename(top + ".new", top)
