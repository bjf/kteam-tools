#!/bin/bash

# TODO:
#  - error handling
#  - parameters
#  - config for mapping 'bionic/main' -> git2/ubuntu-bionic
#  - -v needs to be something ... sometimes
#  - -sa too
#  - unstable is not the series
#  - --meta-option v=<sometihg>
#  - --profile <override> in concert with series-linux as "overrides"

here=`dirname $0`
case "$here" in
/*) ;;
*)  here="`pwd`/$here" ;;
esac

create_chroot()
{
	local series="$1"
	local arch="$2"

	local chroot="$series-$arch"

	# Validate the chroot.
	schroot --directory / -c "$chroot" /bin/true >/dev/null 2>&1 && {
		echo "II: $chroot base chroot available"
		RET="$chroot"
		return
	}

	# Create the base chroot.
	echo "II: $chroot base chroot needed -- creating"

	mk-sbuild --skip-updates --skip-proposed --distro="ubuntu" --arch="$arch" "$series" </dev/null
	sudo sed -i -e 's/^profile=sbuild/profile=default/g' "/etc/schroot/chroot.d/sbuild-$series-$arch"

	RET="$chroot"
}

create_session()
{
	local series="$1"
	local arch="$2"
	local package="$3"

	local session="srcpkg-$series-$arch-$package"

	# Validate the session.
	schroot --directory / -r -c "$session" /bin/true >/dev/null 2>&1 && {
		echo "II: $session session available"
		RET="$session"
		return
	}

	# Validate the chroot.
	create_chroot "$series" "$arch"
	local chroot="$RET"

	# Create the base session.
	echo "II: $session sesssion needed -- creating"

	schroot -b -n "$session" -c "$chroot"

	schroot -u root -r -c "$session" -- apt-get update
	schroot -u root -r -c "$session" -- apt-get -y -o APT::Get::Only-Source=true build-dep --no-install-recommends "$package"
	schroot -u root -r -c "$session" -- apt-get -y install fakeroot
	
	RET="$session"
}

update_session() {
	local series="$1"
	local arch="$2"
	local package="$3"

	create_session "$series" "$arch" "$package"
	local session="$RET"

	schroot -u root -r -c "$session" -- apt-get update
	schroot -u root -r -c "$session" -- apt-get -y dist-upgrade
}

build_src()
{
	local dir="$1"
	local session="$2"
	
	(
		cd "$dir" || exit 1

		git clean -x -f -d
		schroot -r -c "$session" -- fakeroot debian/rules clean
		schroot -r -c "$session" -- dpkg-buildpackage -S -i -I -uc -us -d
	)
}

usage()
{
	cat <<EOF
Usage: cranky build-sources [handle]

Build all source packages for the specified series and source as specified in
kernel-series.yaml.

positional arguments:
  handle                Handle to a kernel source tree, either a path to a
                        kernel source tree or a handle in <series>:<package>
                        format. If not given the current working directory is
                        used.

Examples:
  $ cranky build-sources
      Build all source packages for the kernel source tree in the current
      working directory.
  $ cranky build-sources bionic:linux
      Build all source packages defined under the bionic:linux source in
      ktl/kernel-series.yaml. Finds the source trees based on 'package-path'
      from the cranky config file.
EOF

	exit 2
}

# MAIN:
for opt in "$@"; do
	case $opt in
	-*)
		usage
		;;
	*)
		break;
	esac
	shift
done

case "$#" in
0)
	handle="$PWD"
	;;
1)
	handle="$1"
	;;
*)
	usage
	;;
esac

sources=$( "$here/cranky-shell-helper" "source-packages-path" "$handle" )
series=$( "$here/cranky-shell-helper" "series-codename" "$handle" )

# Ensure we have the updated session -- use amd64/linux for all packages as that
# is a superset.
update_session "$series" "amd64" "linux"
session="$RET"

# Build the source.
for source in $sources
do
	build_src "$source" "$session"
done
