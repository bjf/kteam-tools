#!/usr/bin/python3

# This script generates update.conf used by in-tree helper scripts used to
# produce Ubuntu kernel commits.

import os
import sys

# Add ../libs to the Python search path
sys.path.append(os.path.realpath(os.path.join(os.path.dirname(__file__), os.pardir, os.pardir, 'libs')))

from ktl.debian import Debian
from ktl.shell import sh

def get_repo():
    """
    Return where the repo for the kernel this one is derived from.
    If no one is found, return None.
    """
    source = Debian.get_source_from_kernel_series()
    source = source.derived_from
    if not source:
        return None
    return source.packages[0].repo

REPO = get_repo()
if REPO is None:
    sys.exit(0)

print("RELEASE_REPO=" + REPO.url)
if REPO.branch:
    print("SOURCE_RELEASE_BRANCH=" + REPO.branch)

sh("git fetch " + str(REPO), quiet=True)
print("DEBIAN_MASTER=" + Debian.debian_env(branch="FETCH_HEAD"))
