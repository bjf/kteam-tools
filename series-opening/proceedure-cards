#!/bin/bash

card()
{
	local name="$1"
	local body="$2"

	echo "*** $name ..."

	so-trello list-addcard \
		--board "$trello_board" \
		--list "$trello_list" \
		--card-name "$name" \
		--card-desc "$body"
}

card2()
{
	echo "title<$1>"
	echo "body<$2>"
}

if [ "$#" -ne 3 ]; then
	echo "Usage: $0 <board> <list> <section title>" 1>&2
	exit 1
fi
trello_board="$1"
trello_list="$2"
title="$3"

text="CHECKLIST"

sed \
	-e 's///g' \
	-e "s/‘/'/g" \
	-e "s/’/'/g" \
	-e 's/“/"/g' \
	-e 's/”/"/g' \
 <"$text" | \
awk '
	BEGIN				{ emit=0 }
	/^== '"$title"' ==$/		{ emit=1; next }
	/^$/				{ next }
	/^[^ -]/			{ emit=0; next }
	(/^ -/ && emit)			{ print "EOC" }
	(emit == 1)			{ print $0 }
	END				{ print "EOC" }
' | {
	title=""
	body=""
	while IFS='' read -r line
	do
		case "$line" in
		EOC)
			if [ "$title" != '' ]; then
				card "$title" "$body"
			fi
			title=''
			body=''
			;;
		' - '*)
			title=$( echo "$line" | sed -e 's/^ - //' )
			;;
		*)
			if [ "$body" = '' ]; then
				body="$line"
			else
				body="$body
$line"
			fi
			;;
		esac
	done
}
