#!/bin/bash

so_trello()
{
	so-trello-dev "$@"
}

list()
{
	local board="$1"
	local list="$2"

	echo "LIST $board $list ..."
	so_trello board-addlist \
		--board "$board" \
		--with-name "$list"
}

card()
{
	local board="$1"
	local list="$2"
	local name="$3"
	local body="$4"

	echo "CARD $board/$list $name ..."
	so_trello list-addcard \
		--board "$board" \
		--list "$list" \
		--with-name "$name" \
		--with-desc "$body"
}

checklist()
{
	local board="$1"
	local card="$2"
	local name="$3"

	echo "CHECKLIST $board/$card $name ..."
	so_trello card-addchecklist \
		--board "$board" \
		--card "$card" \
		--with-name "$name"
}
checkitem()
{
	local board="$1"
	local card="$2"
	local checklist="$3"
	local name="$4"

	echo "CHECKITEM $board/$card/$checklist $name ..."
	so_trello checklist-additem \
		--board "$board" \
		--card "$card" \
		--checklist "$checklist" \
		--with-name "$name"
}

if false; then
	list()
	{
		echo "LIST:"
		echo " board<$1>"
		echo " list<$2>"
	}
	card()
	{
		echo "CARD:"
		echo " board<$1>"
		echo " list<$2>"
		echo " title<$3>"
		echo " body<$4>"
	}
	checklist()
	{
		echo "CHECKLIST:"
		echo " board<$1>"
		echo " card<$2>"
		echo " name<$3>"
	}
	checkitem()
	{
		echo "CHECKITEM:"
		echo " board<$1>"
		echo " card<$2>"
		echo " checklist<$3>"
		echo " name<$4>"
	}
fi

if [ "$#" -ne 2 ]; then
	echo "Usage: $0 <board> <proceedure-file>" 1>&2
	exit 1
fi
trello_board="$1"
proceedure="$2"

list "$trello_board" "Done"
list "$trello_board" "In Progress"

sed \
	-e 's///g' \
	-e "s/‘/'/g" \
	-e "s/’/'/g" \
	-e 's/“/"/g' \
	-e 's/”/"/g' \
 <"$proceedure" | \
awk '
	BEGIN				{ emit=0 }
	/== /				{ emit=1; print "EOC"; print; next }
	/^$/				{ next }
	/^[^ -]/			{ emit=0; next }
	(/^ -/ && emit)			{ print "EOC" }
	(emit == 1)			{ print $0 }
	END				{ print "EOC" }
' | {
	title=""
	body=""
	trello_list="Backlog"
	while IFS='' read -r line
	do
		##echo "LINE: $line" | cat -vet
		case "$line" in
		EOC)
			if [ "$title" != '' ]; then
				card "$trello_board" "$trello_list" "$title" "$body"
				trello_card="$title"
			fi
			# Add any checklists and items.
			echo "$body" | \
			{
				let n=0
				while read mark type text
				do
					[ "$type" != 'PREREQ:' ] && continue
					let n="$n+1"
					echo "0 checklist Prerequisites"
					echo "$n checkitem Prerequisites $text"
				done | sort -u | \
				while read order cmd checklist text
				do
					"$cmd" "$trello_board" "$trello_card" "$checklist" "$text"
				done
			}
			title=''
			body=''
			;;
		'== '*)
			trello_list="$line"
			trello_list="${trello_list% ==}"
			trello_list="${trello_list#== }"
			##echo "LIST: $trello_list"
			list "$trello_board" "$trello_list"
			;;
		' - '*)
			title=$( echo "$line" | sed -e 's/^ - //' )
			;;
		*)
			##echo "BODY: $line"
			if [ "$body" = '' ]; then
				body="$line"
			else
				body="$body
$line"
			fi
			;;
		esac
	done
}
