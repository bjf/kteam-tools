export SCRIPTS=$(shell pwd)/scripts
export ACTIVE=$(shell pwd)/active

PKGOUT=$(shell echo $$TARGET)/pkg
BZR_COMMIT=$(shell bzr log --limit=1 --line | cut -d: -f1)

COMBOS=linux touch mix oem
PARTS_linux=linux linux-lts-trusty linux-lts-utopic linux-lts-vivid linux-ti-omap4 linux-armadaxp
PARTS_touch=linux linux-goldfish linux-manta linux-mako linux-flo
PARTS_mix=$(PARTS_linux) $(PARTS_touch)
PARTS_oem=linux linux-lts-quantal linux-lts-saucy linux-lts-trusty linux-lts-utopic linux-lts-vivid linux-ti-omap4 linux-armadaxp

SIMPLE=$(PARTS_linux) $(PARTS_touch) $(PARTS_mix)

all: $(foreach combo,$(COMBOS),$(PKGOUT)/ALL-$(combo).html) $(foreach combo,$(COMBOS),$(PKGOUT)/CVE-$(combo).txt) $(foreach simple,$(SIMPLE),$(PKGOUT)/$(simple).html)

$(PKGOUT)/.bzr-version:
	echo "$(BZR_COMMIT)" >$(PKGOUT)/.bzr-version+
	cmp $(PKGOUT)/.bzr-version $(PKGOUT)/.bzr-version+ 2>/dev/null || mv $(PKGOUT)/.bzr-version+ $(PKGOUT)/.bzr-version

# For each combination page build a combined CVE list in .raw and build a merged page from it
define COMBO_template
$(PKGOUT)/ALL-$(1).html: $$(foreach part,$$(PARTS_$(1)),$(PKGOUT)/$$(part)_$(1).html) $$(HOME)/cve-autotriage/state/CVE-notes
	$$(HOME)/cve-matrix/cve-merge $$(HOME)/cve-autotriage/state/CVE-notes $$^ | sed -e 's/linux-//g' -e 's/lts-backport-/lts-/g' -e 's/lts-/LTS /g' >"$$@"

$(PKGOUT)/CVE-$(1).txt: $$(foreach part,$$(PARTS_$(1)),$(PKGOUT)/$$(part)_$(1).html)
	$$(HOME)/cve-matrix/cve-merge-payload cve-report - $$^ >"$$@"

$(TARGET)/.raw/%_$(1): $$(foreach part,$$(PARTS_$(1)),$(TARGET)/.raw/$$(part))
	cat $$^ | sort -u >"$$@"

include $$(foreach part,$$(PARTS_$(1)),$(PKGOUT)/.$$(part)_$(1).html.d)
endef
$(foreach combo,$(COMBOS),$(eval $(call COMBO_template,$(combo))))

include $(foreach simple,$(SIMPLE),$(PKGOUT)/.$(simple).html.d)

# Generate a .html from its associated list of CVEs
$(PKGOUT)/%.html: $(TARGET)/.raw/%
	$(SCRIPTS)/html-export-pkg.py --commit $(BZR_COMMIT) $(shell basename "$@" .html | sed -e 's/_.*//') $(foreach cve,$(shell cat $<),active/$(cve)) >"$@.tmp"
	mv "$@.tmp" "$@"

$(PKGOUT)/.%.html.d: $(TARGET)/.raw/%
	( echo '$(PKGOUT)/$*.html: '; sed -e 's@^@$$(ACTIVE)/@' <$^ ) | tr '\n' ' ' >"$@"
