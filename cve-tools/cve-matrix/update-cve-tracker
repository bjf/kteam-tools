#!/bin/bash

set -e
shopt -s extglob

here=`dirname $0`
case "$here" in
/*) ;;
*)  here="`pwd`/$here" ;;
esac

export http_proxy=http://squid.internal:3128/

root="$HOME/cve-matrix"
cves="$root/CVE-result-cves"
tracker="$root/cve-tracker"
scripts="$tracker/scripts"
out="$HOME/public_html/cve/pkg"

# Pull tree changes
if [ ! -d "$tracker" ]; then
	mkdir -p "$root"
	bzr branch lp:~canonical-kernel-team/ubuntu-cve-tracker/kernel-team "$tracker"
fi
cd "$tracker"
bzr revert
bzr pull --overwrite ../../cve-autotriage/cve-tracker >/dev/null 2>&1
bzr revert
cp "$here/bulk-html-export-pkg.py" "$tracker/scripts"

# BODGE
##cp "$here/html_export.py" "$scripts"

# Identify all kernel cves.
(
	cd "$tracker" || exit 1

	cves=(active/CVE-+([0-9])-+([0-9]))
	cat "${cves[@]}" | \
		awk '
			/^Candidate:/			{ cve="active/" $2; next }
			/^Patches_linux:/		{ print(cve); next }
	'
) >"$cves"

# Prepare the output.
mkdir -p "$out"

#$scripts/html-export-pkg.py --commit 1 linux-krillin `awk '/ product linux-krillin / { print $1 }' ~/cve-autotriage/state/CVE-result-cves` >~/public_html/cve/pkg/X.html

[ ! -f "$out/../toplevel.css" ] && cp "$scripts/html-top/toplevel.css" "$out/.."

pkgs="
    linux linux-lts-trusty linux-lts-utopic linux-lts-vivid linux-lts-wily linux-lts-xenial linux-hwe linux-hwe-edge
    linux-aws linux-gke
    linux-ti-omap4 linux-armadaxp linux-raspi2 linux-snapdragon 
    linux-goldfish linux-manta linux-mako linux-flo linux-krillin linux-vegetahd
"
for pkg in $pkgs
do
    echo "$out/$pkg-full.html $pkg"
done | $scripts/bulk-html-export-pkg.py $( cat "$cves" )
for pkg in $pkgs
do
    echo "merge $pkg"
    $here/cve-merge ${HOME}/cve-autotriage/state/CVE-notes "$out/$pkg-full.html" >"$out/$pkg.html"
done

echo "combo ALL-linux"
$here/cve-merge ${HOME}/cve-autotriage/state/CVE-notes \
	$out/linux-full.html \
	$out/linux-lts-trusty-full.html \
	$out/linux-lts-xenial-full.html \
	$out/linux-hwe-full.html \
	$out/linux-hwe-edge-full.html \
	$out/linux-aws-full.html \
	$out/linux-gke-full.html \
	$out/linux-raspi2-full.html \
	$out/linux-snapdragon-full.html \
	$out/linux-ti-omap4-full.html \
	$out/linux-armadaxp-full.html \
    >$out/ALL-linux.html

echo "combo ALL-touch"
$here/cve-merge ${HOME}/cve-autotriage/state/CVE-notes \
    $out/linux-full.html $out/linux-goldfish-full.html $out/linux-manta-full.html $out/linux-mako-full.html $out/linux-flo-full.html $out/linux-krillin-full.html $out/linux-vegetahd-full.html \
        >$out/ALL-touch.html

echo "combo ALL-product"
$here/cve-merge ${HOME}/cve-autotriage/state/CVE-notes \
    $out/linux-full.html $out/linux-krillin-full.html $out/linux-vegetahd-full.html \
        >$out/ALL-product.html

date
