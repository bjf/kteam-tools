#!/bin/bash
set -e
export http_proxy=http://squid.internal:3128/

root="$HOME/cve-matrix"
tracker="$root/cve-tracker"
export TARGET=$HOME/public_html/cve

# Pull tree changes
if [ ! -d "$tracker" ]; then
	mkdir -p "$root"
	bzr branch lp:~canonical-kernel-team/ubuntu-cve-tracker/kernel-team "$tracker"
fi
cd "$tracker"
bzr pull --overwrite ../../cve-autotriage/cve-tracker >/dev/null 2>&1
bzr revert

if [ ! -e "$root/cve-merge" ]; then
	ln -s "$HOME/kteam-tools/cve-tools/cve-matrix/cve-merge" "$root"
fi
if [ ! -e "$root/cve-merge-payload" ]; then
	ln -s "$HOME/kteam-tools/cve-tools/cve-matrix/cve-merge-payload" "$root"
fi
if [ ! -e "$tracker/Makefile.combo" ]; then
	ln -s $HOME/kteam-tools/cve-tools/cve-matrix/Makefile.combo "$tracker"
fi

# Generate CVE tables and items
mkdir -p "$TARGET/pkg"
make --quiet -j3 cves
./scripts/generate-pkgs-makefile.py >$TARGET/.pkg-makefile
make -f Makefile.combo

ofile="$HOME/public_html/status/cve-matrix.dashboard"
echo "Matrix%sRebuild `date +%s` 1800 2700" >"$ofile.new"
mv -f "$ofile.new" "$ofile"

date
