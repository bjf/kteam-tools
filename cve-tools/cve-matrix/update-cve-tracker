#!/bin/bash
set -e

here=`dirname $0`
case "$here" in
/*) ;;
*)  here="`pwd`/$here" ;;
esac

export http_proxy=http://squid.internal:3128/

root="$HOME/cve-matrix"
cves="$root/CVE-result-cves"
tracker="$root/cve-tracker"
scripts="$tracker/scripts"
out="$HOME/public_html/cve/pkg"

# Pull tree changes
if [ ! -d "$tracker" ]; then
	mkdir -p "$root"
	bzr branch lp:~canonical-kernel-team/ubuntu-cve-tracker/kernel-team "$tracker"
fi
cd "$tracker"
bzr revert
bzr pull --overwrite ../../cve-autotriage/cve-tracker >/dev/null 2>&1
bzr revert

# BODGE
cp "$here/html_export.py" "$scripts"

# Take a cached copy of the cve list in case it were to change under us.
awk '/ upstream linux / { print $1 }' "$HOME/cve-autotriage/state/CVE-result-cves" | sort -u >"$cves"

# Prepare the output.
mkdir -p "$out"

#$scripts/html-export-pkg.py --commit 1 linux-krillin `awk '/ product linux-krillin / { print $1 }' ~/cve-autotriage/state/CVE-result-cves` >~/public_html/cve/pkg/X.html

for pkg in \
    linux linux-lts-trusty linux-lts-utopic linux-lts-vivid linux-ti-omap4 linux-armadaxp \
    linux-goldfish linux-manta linux-mako linux-flo linux-krillin linux-vegetahd
do
    echo "individual $pkg ..."
    $scripts/html-export-pkg.py "$pkg" `cat "$cves"` >"$out/$pkg-full.html"
    $here/cve-merge ${HOME}/cve-autotriage/state/CVE-notes "$out/$pkg-full.html" >"$out/$pkg.html"
done

echo "combo ALL-linux"
$here/cve-merge ${HOME}/cve-autotriage/state/CVE-notes \
    $out/linux-full.html $out/linux-lts-trusty-full.html $out/linux-lts-utopic-full.html $out/linux-lts-vivid-full.html $out/linux-ti-omap4-full.html $out/linux-armadaxp-full.html \
        >$out/ALL-linux.html

echo "combo ALL-touch"
$here/cve-merge ${HOME}/cve-autotriage/state/CVE-notes \
    $out/linux-full.html $out/linux-goldfish-full.html $out/linux-manta-full.html $out/linux-mako-full.html $out/linux-flo-full.html $out/linux-krillin-full.html $out/linux-vegetahd-full.html \
        >$out/ALL-touch.html

echo "combo ALL-product"
$here/cve-merge ${HOME}/cve-autotriage/state/CVE-notes \
    $out/linux-full.html $out/linux-krillin-full.html $out/linux-vegetahd-full.html \
        >$out/ALL-product.html

date
