#!/usr/bin/python

import sys
import re

re_package = re.compile('<h2.*?>(.*?)</h2>')
re_headings = re.compile('<tr>.*?<th>')
re_cve = re.compile('(<tr class=".*?">).*?(<td class="cve">.*?>(CVE-....-....)</a></td>)')

re_th = re.compile('<th.*?>(.*?)</th>')
re_td = re.compile('(<td.*?>)(.*?)(</td>)')

packages = list()
# headers[package] = [ ... ]
headers = {}
# series[package] = [ ... ]
series = {}
# cves[cve_num] = [ priority, html_title ]
cves = {}
# cve_status[package, cve_num]
cve_status = {}
# missing[$package] = "...."
missing = {}
# valid[package_name] = [ ... ]
valid = {}
# summary[package] = [ ... ]
summary = {}
summary_deferred = {}
# cve_note[cve_num, package, series] = note
cve_note = {}

html = ''
cve_report = ''

(mode, notef) = (sys.argv[1:3])

if notef != "-":
    with file(notef) as fh:
        for line in fh:
            (cve_num, note_series, package, status, note) = line.strip().split(' ', 4)
            note = note.replace('%s', ' ').replace('%%', '%')
            cve_note[cve_num, package, note_series] = (status, note)

for filename in sys.argv[3:]:
    package_name = None
    with file(filename) as fh:
        for line in fh:
            # Pick out the package name ...
            match = re_package.search(line)
            if match:
                package_name = match.group(1)
                packages.append(package_name)

            # Pick out the headers ...
            match = re_headings.search(line)
            if match:
                if package_name not in series:
                    series[package_name] = []
                if package_name not in headers:
                    headers[package_name] = []
                for hmatch in re_th.finditer(line):
                    series[package_name].append(hmatch.group(1))
                    h = "<th class=\"allborders\">" + hmatch.group(1) + "</th>"
                    headers[package_name].append(h)
                series[package_name].pop(0)
                headers[package_name].pop(0)

            # Pick out CVE entries ...
            match = re_cve.search(line)
            if match:
                cve_num = match.group(3)
                cves[cve_num] = (match.group(1), match.group(2))

                if (package_name, cve_num) not in cve_status:
                    cve_status[package_name, cve_num] = list()
                cnt = -1
                for tmatch in re_td.finditer(line):
                    cve_stat = tmatch.group(0)
                    if cnt >= 0:
                        # Extract the series name, removing marks for unsupported etc.
                        cve_series = series[package_name][cnt].lower().rstrip('*')
                        if (cve_num, package_name, cve_series) in cve_note:
                            (cve_status_is, cve_notes) = cve_note[cve_num, package_name, cve_series] 
                            if cve_status_is in ('*', tmatch.group(2).rstrip('*')):
                                cve_stat = tmatch.group(1) + tmatch.group(2) + \
                                    "<br>" + cve_notes + tmatch.group(3)

                    # Record valid entries ...
                    if tmatch.group(2).rstrip('*') not in ('--', 'ignored'):
                        if package_name not in valid:
                            valid[package_name] = {}
                        if cnt >= 0:
                            valid[package_name][cnt] = True
                            if package_name not in summary:
                                summary[package_name] = {}
                                summary_deferred[package_name] = {}
                            if cnt not in summary[package_name]:
                                summary[package_name][cnt] = 0
                                summary_deferred[package_name][cnt] = 0

                    interesting = False
                    if tmatch.group(2).rstrip('*') not in ('--', 'ignored', 'not-affected', 'released'):
                        interesting = True
                    cve_status[package_name, cve_num].append((cve_stat, interesting))

                    # Count open entries ...
                    if tmatch.group(2) in ('deferred', 'needs-triage', 'needed'):
                        summary[package_name][cnt] += 1
                    if tmatch.group(2) in ('deferred'):
                        summary_deferred[package_name][cnt] += 1
                    cnt += 1
                cve_status[package_name, cve_num].pop(0)

# Drop completely empty packages
opackages = packages
packages = list()
for package in opackages:
    if package in summary:
        packages.append(package)

# Drop any columns which have no valid data
for package_name in packages:
    new = list()
    for cnt in range(0, len(headers[package_name])):
        if package_name in valid and cnt in valid[package_name]:
            new.append(headers[package_name][cnt])
    headers[package_name] = new

for package_name in packages:
    missing[package_name] = "<td></td>" * len(headers[package_name])

html +=  "<tr><th class=\"allborders\"></th>"
for package_name in packages:
    html += '<th class=\"allborders\" colspan="%d">%s</th>' % (len(headers[package_name]), package_name)
html += "</tr>\n"

html += "<tr><th class=\"allborders\">CVE</th>"
for package_name in packages:
    html += "".join(headers[package_name])
html += "</tr>\n"

non_empty = 0
for cve_num in sorted(cves):
    empty = True
    html_frag = "%s%s" % (cves[cve_num][0], cves[cve_num][1])
    for package_name in packages:
        if (package_name, cve_num) in cve_status:
            cnt = 0
            for (cell, interesting) in cve_status[package_name, cve_num]:
                if package_name in valid and cnt in valid[package_name]:
                    html_frag += cell
                    if interesting:
                        empty = False
                cnt += 1
        else:
            html_frag += missing[package_name]
    html_frag += "</tr>\n"
    if not empty:
        html += html_frag
        non_empty += 1

html += "<tr><th class=\"allborders\">Open (of %d)</th>" % (non_empty)
for package_name in packages:
    for cnt in sorted(summary[package_name].keys()):
        html += "<th class=\"allborders\">%d (%d)</th>" % (summary[package_name][cnt], summary_deferred[package_name][cnt])
html += "</tr>\n"

html += "<tr><th></th>"
for package_name in packages:
    html += '<th  class=\"allborders\" colspan="%d">%s</th>' % (len(headers[package_name]), package_name)
html += "</tr>\n"

html +=  "<tr><th class=\"allborders\">CVE</th>"
for package_name in packages:
    html += "".join(headers[package_name])
html += "</tr>\n"

# CVE report
cve_report += "=== CVE Metrics ===\n\n"
cve_report += "[LINK] http://people.canonical.com/~kernel/cve/pkg/CVE-linux.txt\n\n"
cve_report += 'Currently open CVEs for each supported branch:\n\n'
cve_report += "|| %-40.40s || %-4.4s || %-4.4s ||\n" % ("Package", "Open", "Defd")
cve_report += "|| %-40.40s || %-4.4s || %-4.4s ||\n" % ("", "", "")
for package_name in packages:
    for cnt in sorted(summary[package_name].keys()):
        cve_report += "|| %-40.40s || %4d || %4d ||\n" % (package_name + " " + series[package_name][cnt], summary[package_name][cnt], summary_deferred[package_name][cnt])

if mode == 'html':
    print html
elif mode == 'cve-report':
    print cve_report
