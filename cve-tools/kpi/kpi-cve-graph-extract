#!/usr/bin/python3 
from collections import defaultdict
import json
import sys


gauges = {}
date = sys.argv[1]
with open(date) as info_fd:
    info = json.load(info_fd)

for key in info:
    (series, package) = key.split()

    if series in ('upstream', 'devel'):
        continue

    # This almost cirtainly represents closure.
    if info[key]['state']['summary'].get('open', 0) == 0:
        continue

    #total = 0
    #result = []
    #for state in ('critical', 'high', 'medium', 'low', 'negligible'):
    #    delta = (info[key]['priority']['by-summary']['open'].get(state, 0) -
    #             info[key]['priority']['by-state'].get('pending', {}).get(state, 0))
    #    total += delta
    #    result.append(delta)

    labels = 'series="' + series + '",source="' + package + '"'
    gauges.setdefault('open', {})[labels] = info[key]['state']['summary'].get('open', 0)
    gauges.setdefault('needswork', {})[labels] = (info[key]['state']['summary'].get('open', 0) - 
                                                  info[key]['state']['total'].get('pending', 0))


for gauge_key in sorted(gauges):
    gauge_name = 'kernel_cves_v1_' + gauge_key
    print('# HELP ' + gauge_name + ' help')
    print('# TYPE ' + gauge_name + ' gauge')
    for labels in gauges[gauge_key]:
        value = gauges[gauge_key][labels]
        print(gauge_name + '{' + labels + '}', value)
