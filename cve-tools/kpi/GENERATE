#!/bin/bash
#
# Designed to be used with the below list of crontab entries to
# generate the data every 15m but to keep it seemingly fresh
# for prometheus to scrape by updating its timestamps every 3m.
# We take a monthly historical sample on the first of the month.
# We regenerate the graphs every 4 hours to keep the "latest"
# sample reasonably fresh.
#
#  */15     *          *         *                  *                  (cd "$HOME/public_html/status/kpi" && "$HOME/kteam-tools/cve-tools/kpi/GENERATE" generate)
#  */3      *          *         *                  *                  (cd "$HOME/public_html/status/kpi" && "$HOME/kteam-tools/cve-tools/kpi/GENERATE" timestamp)
#     0     0          1         *                  *                  (cd "$HOME/public_html/status/kpi" && "$HOME/kteam-tools/cve-tools/kpi/GENERATE" history-sample)
#    15   */4          *         *                  *                  (cd "$HOME/public_html/status/kpi" && "$HOME/kteam-tools/cve-tools/kpi/GENERATE" generate-graphs)
#

date=`date --date "today" +%Y-%m-%d`

case "$1" in
generate)
    (cd "$HOME/cve-autotriage/cve-tracker" &&
        "$HOME/kteam-tools/cve-tools/kpi/kpi-cve-extract" "$date") >cve-info.json.new
    mv cve-info.json.new cve-info.json
    if [ ! -e historical/data/LATEST.json ]; then
	ln -s ../../cve-info.json historical/data/LATEST.json
    fi
    ;;
timestamp)
    "$HOME/kteam-tools/cve-tools/kpi/kpi-cve-graph-extract" cve-info.json >cve-info.txt.new
    mv cve-info.txt.new cve-info.txt
    ;;
generate-graphs)
    (cd historical/data && mkdir -p NEW && "$HOME/kteam-tools/cve-tools/kpi/kpi-cve-graph-all" NEW)
    mv historical/data/NEW/* historical
    ;;
history-sample)
    cp cve-info.json "historical/data/$date.json"
    ;;
esac
