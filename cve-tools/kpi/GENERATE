#!/bin/bash
#
# Designed to be used with the below list of crontab entries to
# generate the data every 15m but to keep it seemingly fresh
# for prometheus to scrape by updating its timestamps every 3m.
# We take a monthly historical sample on the first of the month.
# We regenerate the graphs every 4 hours to keep the "latest"
# sample reasonably fresh.
#
#    15   */4          *         *                  *                  (cd "$HOME/public_html/status/kpi" && "$HOME/kteam-tools/cve-tools/kpi/GENERATE" generate)
#     0     0          1         *                  *                  (cd "$HOME/public_html/status/kpi" && "$HOME/kteam-tools/cve-tools/kpi/GENERATE" history-sample)
#

date=`date --date "today" +%Y-%m-%d`

case "$1" in
generate)
    (cd "$HOME/cve-autotriage/cve-tracker" &&
        "$HOME/kteam-tools/cve-tools/kpi/kpi-cve-extract" "$date") >cve-info.json.new
    mv cve-info.json.new cve-info.json
    next=$( date "+%Y-%m-01" --date "now + 1 month" )
    sed -e 's/"date": "[0-9][0-9]*-[0-9][0-9]*-[0-9][0-9]*"/"date": "'"$next"'"/' <cve-info.json >historical/data/LATEST.json.new
    mv historical/data/LATEST.json.new historical/data/LATEST.json
    (cd historical/data && $HOME/kteam-tools/cve-tools/kpi/kpi-cve-influx) >cve-info.influx
    curl --netrc-file $HOME/.influx-kernel.auth -i -XPOST 'http://influxdb.cloud.kpi.internal:8086/write?db=kernel' --data-binary '@cve-info.influx'
    ;;
history-sample)
    cp cve-info.json "historical/data/$date.json"
    ;;
esac
