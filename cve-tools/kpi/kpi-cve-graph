#!/usr/bin/python
from __future__ import print_function

from collections import defaultdict
import datetime
import json
import sys

epoch = datetime.datetime.utcfromtimestamp(0)

def date_to_influx_ts(date):
    dt = datetime.datetime.strptime(date, "%Y-%m-%d")
    timestamp = int((dt - epoch).total_seconds() * 1000000000.0)

    return timestamp

#
#>>> import time
#>>> import datetime
#>>> s = "01/12/2011"
#>>> time.mktime(datetime.datetime.strptime(s, "%d/%m/%Y").timetuple())
#1322697600.0



(mode, series, package) = (sys.argv[1:4])
key = series + " " + package
prev = None
for date in sys.argv[4:]:
    with open(date) as info_fd:
        data = json.load(info_fd)

    date = data['meta']['date']
    date_influx = date_to_influx_ts(date)

    info = data['by-series-package']
    if key not in info:
        continue
    curr = info[key]

    if mode in ('open', 'closed'):
        # This almost cirtainly represents closure.
        if curr['state']['summary'].get('open', 0) == 0:
            continue

        print(date,
            curr['priority']['by-summary'][mode].get('critical', 0),
            curr['priority']['by-summary'][mode].get('high', 0),
            curr['priority']['by-summary'][mode].get('medium', 0),
            curr['priority']['by-summary'][mode].get('low', 0),
            curr['priority']['by-summary'][mode].get('negligible', 0),
        )

    elif mode in ('open-0', 'closed-0'):
        # This almost cirtainly represents closure.
        if curr['state']['summary'].get('open', 0) == 0:
            continue

        if prev == None:
            prev = curr
            continue

        mode_key = mode[0:-2]
        print(date,
            curr['priority']['by-summary'][mode_key].get('critical', 0) -
            prev['priority']['by-summary'][mode_key].get('critical', 0),
            curr['priority']['by-summary'][mode_key].get('high', 0) -
            prev['priority']['by-summary'][mode_key].get('high', 0),
            curr['priority']['by-summary'][mode_key].get('medium', 0) -
            prev['priority']['by-summary'][mode_key].get('medium', 0),
            curr['priority']['by-summary'][mode_key].get('low', 0) -
            prev['priority']['by-summary'][mode_key].get('low', 0),
            curr['priority']['by-summary'][mode_key].get('negligible', 0) -
            prev['priority']['by-summary'][mode_key].get('nedligible', 0),
        )

    elif mode in ('influx-open0', 'influx-closed0'):
        # This almost cirtainly represents closure.
        if curr['state']['summary'].get('open', 0) == 0:
            continue

        if prev == None:
            prev = curr
            continue

        mode_key = mode[7:-1]
        result = [ "cves_{},series={},package={}".format(mode[7:], series, package) ]
        values = []
        for state in ('critical', 'high', 'medium', 'low', 'negligible'):
            values.append("{}={}".format(state,
                curr['priority']['by-summary'][mode_key].get(state, 0) -
                prev['priority']['by-summary'][mode_key].get(state, 0))
            )
        #values.append("date={}".format(date))
        result.append(','.join(values))
        result.append(date_influx)
        print(*result)

    elif mode == 'needswork-detail':
        # This almost cirtainly represents closure.
        if curr['state']['summary'].get('open', 0) == 0:
            continue

        total = 0
        result = []
        for state in ('critical', 'high', 'medium', 'low', 'negligible'):
            delta = (curr['priority']['by-summary']['open'].get(state, 0) -
                     curr['priority']['by-state'].get('pending', {}).get(state, 0))
            total += delta
            result.append(delta)
        
        print(date, total, *result)

    elif mode == 'needswork':
        # This almost cirtainly represents closure.
        if curr['state']['summary'].get('open', 0) == 0:
            continue

        total = 0
        result = []
        for state in ('critical', 'high', 'medium', 'low', 'negligible'):
            delta = (curr['priority']['by-summary']['open'].get(state, 0) -
                     curr['priority']['by-state'].get('pending', {}).get(state, 0))
            total += delta
            result.append(delta)
        
        print(date,
            curr['state']['summary'].get('open', 0),
            (curr['state']['summary'].get('open', 0) - 
             curr['state']['total'].get('pending', 0))
        )

    elif mode == 'delta':
        if prev != None:
            total = 0
            result = []
            for priority in ('critical', 'high', 'medium', 'low', 'negligible'):
                dead_p = prev['priority']['by-summary']['closed'].get(priority, 0)
                total_p = prev['priority']['total'].get(priority, 0)
                dead_c = curr['priority']['by-summary']['closed'].get(priority, 0)
                total_c = curr['priority']['total'].get(priority, 0)
                delta = (total_c - total_p) - (dead_c - dead_p)

                #print(total_c, total_p, total_c - total_p, dead_c, dead_p, dead_c - dead_p, delta, file=sys.stderr)
                result.append(str(delta))
                total += delta
            #print("APW", " ".join([date, str(total)] + result), file=sys.stderr)
            print(" ".join([date, str(total)] + result))

        prev = curr

    elif mode == 'open-delta':
        # This almost cirtainly represents closure.
        if curr['state']['summary'].get('open', 0) == 0:
            continue

        if prev != None:
            result = []
            for priority in ('critical', 'high', 'medium', 'low', 'negligible'):
                prev_cves = set()
                curr_cves = set()
                for summary in ('open', 'closed'):
                    prev_cves.update(prev['priority']['by-summary-list'].get(priority, {}).get(summary, []))
                    curr_cves.update(curr['priority']['by-summary-list'].get(priority, {}).get(summary, []))

                new = curr_cves - prev_cves
                #print(new, file=sys.stderr)
                result.append(str(len(new)))
            print(" ".join([date] + result))

        prev = curr

    elif mode == 'influx-open-delta':
        # This almost cirtainly represents closure.
        if curr['state']['summary'].get('open', 0) == 0:
            continue

        if prev != None:
            result = [ "cves_{},series={},package={}".format(mode[7:].replace('-', '_'), series, package) ]
            fields = []
            for priority in ('critical', 'high', 'medium', 'low', 'negligible'):
                prev_cves = set()
                curr_cves = set()
                for summary in ('open', 'closed'):
                    prev_cves.update(prev['priority']['by-summary-list'].get(priority, {}).get(summary, []))
                    curr_cves.update(curr['priority']['by-summary-list'].get(priority, {}).get(summary, []))

                new = curr_cves - prev_cves
                #print(new, file=sys.stderr)
                fields.append("{}={}".format(priority, str(len(new))))
            result.append(','.join(fields))
            result.append(str(date_influx))
            print(" ".join(result))

        prev = curr

    elif mode == 'closed-delta':
        # This almost cirtainly represents series closure.
        if curr['state']['summary'].get('open', 0) == 0:
            continue

        if prev != None:
            result = []
            for priority in ('critical', 'high', 'medium', 'low', 'negligible'):
                prev_cves = set()
                curr_cves = set()
                prev_cves.update(prev['priority']['by-summary-list'].get(priority, {}).get('closed', []))
                curr_cves.update(curr['priority']['by-summary-list'].get(priority, {}).get('closed', []))

                new = curr_cves - prev_cves
                #print("APW", str(len(prev_cves)), str(len(curr_cves)), str(len(new)), file=sys.stderr)
                result.append(str(len(new)))
            print(" ".join([date] + result))

        prev = curr

    else:
        raise(ValueError("Unknown Mode"))
