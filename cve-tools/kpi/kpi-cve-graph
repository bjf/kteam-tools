#!/usr/bin/python
from __future__ import print_function

from collections import defaultdict
import json
import sys

(mode, series, package) = (sys.argv[1:4])
key = series + " " + package
prev = None
for date in sys.argv[4:]:
    with open(date) as info_fd:
        data = json.load(info_fd)

    date = data['meta']['date']

    info = data['by-series-package']
    if key not in info:
        continue
    curr = info[key]

    if mode in ('open', 'closed'):
        # This almost cirtainly represents closure.
        if curr['state']['summary'].get('open', 0) == 0:
            continue

        print(date,
            curr['priority']['by-summary'][mode].get('critical', 0),
            curr['priority']['by-summary'][mode].get('high', 0),
            curr['priority']['by-summary'][mode].get('medium', 0),
            curr['priority']['by-summary'][mode].get('low', 0),
            curr['priority']['by-summary'][mode].get('negligible', 0),
        )

    elif mode in ('open-0', 'closed-0'):
        # This almost cirtainly represents closure.
        if curr['state']['summary'].get('open', 0) == 0:
            continue

        if prev == None:
            prev = curr
            continue

        mode_key = mode[0:-2]
        print(date,
            curr['priority']['by-summary'][mode_key].get('critical', 0) -
            prev['priority']['by-summary'][mode_key].get('critical', 0),
            curr['priority']['by-summary'][mode_key].get('high', 0) -
            prev['priority']['by-summary'][mode_key].get('high', 0),
            curr['priority']['by-summary'][mode_key].get('medium', 0) -
            prev['priority']['by-summary'][mode_key].get('medium', 0),
            curr['priority']['by-summary'][mode_key].get('low', 0) -
            prev['priority']['by-summary'][mode_key].get('low', 0),
            curr['priority']['by-summary'][mode_key].get('negligible', 0) -
            prev['priority']['by-summary'][mode_key].get('nedligible', 0),
        )

    elif mode == 'needswork-detail':
        # This almost cirtainly represents closure.
        if curr['state']['summary'].get('open', 0) == 0:
            continue

        total = 0
        result = []
        for state in ('critical', 'high', 'medium', 'low', 'negligible'):
            delta = (curr['priority']['by-summary']['open'].get(state, 0) -
                     curr['priority']['by-state'].get('pending', {}).get(state, 0))
            total += delta
            result.append(delta)
        
        print(date, total, *result)

    elif mode == 'needswork':
        # This almost cirtainly represents closure.
        if curr['state']['summary'].get('open', 0) == 0:
            continue

        total = 0
        result = []
        for state in ('critical', 'high', 'medium', 'low', 'negligible'):
            delta = (curr['priority']['by-summary']['open'].get(state, 0) -
                     curr['priority']['by-state'].get('pending', {}).get(state, 0))
            total += delta
            result.append(delta)
        
        print(date,
            curr['state']['summary'].get('open', 0),
            (curr['state']['summary'].get('open', 0) - 
             curr['state']['total'].get('pending', 0))
        )

    elif mode == 'delta':
        if prev != None:
            total = 0
            result = []
            for priority in ('critical', 'high', 'medium', 'low', 'negligible'):
                dead_p = prev['priority']['by-summary']['closed'].get(priority, 0)
                total_p = prev['priority']['total'].get(priority, 0)
                dead_c = curr['priority']['by-summary']['closed'].get(priority, 0)
                total_c = curr['priority']['total'].get(priority, 0)
                delta = (total_c - total_p) - (dead_c - dead_p)

                #print(total_c, total_p, total_c - total_p, dead_c, dead_p, dead_c - dead_p, delta, file=sys.stderr)
                result.append(str(delta))
                total += delta
            #print("APW", " ".join([date, str(total)] + result), file=sys.stderr)
            print(" ".join([date, str(total)] + result))

        prev = curr

    elif mode == 'open-delta':
        # This almost cirtainly represents closure.
        if curr['state']['summary'].get('open', 0) == 0:
            continue

        if prev != None:
            result = []
            for priority in ('critical', 'high', 'medium', 'low', 'negligible'):
                prev_cves = set()
                curr_cves = set()
                for summary in ('open', 'closed'):
                    prev_cves.update(prev['priority']['by-summary-list'].get(priority, {}).get(summary, []))
                    curr_cves.update(curr['priority']['by-summary-list'].get(priority, {}).get(summary, []))

                new = curr_cves - prev_cves
                #print(new, file=sys.stderr)
                result.append(str(len(new)))
            print(" ".join([date] + result))

        prev = curr

    elif mode == 'closed-delta':
        # This almost cirtainly represents series closure.
        if curr['state']['summary'].get('open', 0) == 0:
            continue

        if prev != None:
            result = []
            for priority in ('critical', 'high', 'medium', 'low', 'negligible'):
                prev_cves = set()
                curr_cves = set()
                prev_cves.update(prev['priority']['by-summary-list'].get(priority, {}).get('closed', []))
                curr_cves.update(curr['priority']['by-summary-list'].get(priority, {}).get('closed', []))

                new = curr_cves - prev_cves
                #print("APW", str(len(prev_cves)), str(len(curr_cves)), str(len(new)), file=sys.stderr)
                result.append(str(len(new)))
            print(" ".join([date] + result))

        prev = curr

    else:
        raise(ValueError("Unknown Mode"))
