#! /bin/bash

here=`dirname $0`
case "$here" in
/*) ;;
*)  here="`pwd`/$here" ;;
esac

if [ "$#" -ne 1 ]; then
	echo "Usage: $0 daily|weekly|monthly" 1>&2
	exit 1
fi

tmp="/tmp/kpi-cve-generate.$$"

## Ensure our tree is up to date.
#bzr pull --overwrite

# Find out where we are so we can come back here.
start_id=$( bzr log -l 1 --show-ids | awk '/^revision-id:/ { print $2 }' )
echo "$start_id" >".start-id"

# We are going to shift the tree to generate these summaries
# so we have to take the list en-toto beforehand.
"$here/kpi-cve-select" "$1" >"$tmp"

mkdir -p 'KPI'
while read id date
do
	[ -f "KPI/$date.json" ] && continue

	echo "$id $date ..."
	bzr pull . --overwrite -r "$id"
	"$here/kpi-cve-extract" "$date" >"KPI/$date.json"
done <"$tmp"

rm -f "$tmp"

# Put the tree back.
echo "restoring tree: $start_id"
bzr pull . --overwrite -r "$start_id"
