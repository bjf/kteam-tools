#!/bin/bash

here=`dirname $0`
case "$here" in
/*) ;;
*)  here="`pwd`/$here" ;;
esac

if [ "$#" -ne 1 ]; then
	echo "Usage: $0 <output directory>" 1>&2
	exit 1
fi
out="$1"

plot="/tmp/plot.$$"

plot_header()
{
	local colour="$1"

	cat - <<EOL
colour_fg = "$colour"
colour_g1 = "#7eb26d"
colour_g2 = "#eab839"
colour_g3 = "#6ed0e0"
colour_g4 = "#ef843c"
colour_g5 = "#e24d42"
colour_g6 = "#1f78c1"
colour_g7 = "#ba43a9"
colour_g8 = "#705da0"

colour_l1 = colour_g1
colour_l2 = colour_g2
colour_l3 = colour_g3
colour_l4 = colour_g4
colour_l5 = colour_g5
colour_l6 = colour_g6
colour_l7 = colour_g7
colour_l8 = colour_g8

colour_critical =	colour_g5
colour_high =		colour_g4
colour_medium =		colour_g2
colour_low =		colour_g3
colour_negligible =	colour_g6
colour_total =		colour_g1
colour_label =		colour_fg

EOL
	[ "$colour" != 'black' ] && cat - <<EOL
set border linecolor rgb colour_fg
set xtics textcolor rgb colour_fg
set ytics textcolor rgb colour_fg
set key textcolor rgb colour_fg
set title textcolor rgb colour_fg
set xlabel textcolor rgb colour_fg
set ylabel textcolor rgb colour_fg

EOL
	cat - <<EOL
set terminal svg size 600,300 dynamic

set xdata time
set timefmt "%Y-%m-%d"
set format x "%Y-%m-%d"

set tmargin 2.0
set bmargin 5.5
set key below samplen 2 spacing .5 font ",7"

#set xtics rotate by 45 offset -2.2,-2.2
set xtics rotate font ",8"

set yrange [0:*]
set ytics font ",8"

EOL
}

plot_open_total_line_template()
{
	local colour="$1"
	plot_header "$colour"
	cat - <<'EOL'
plot \
 filename using 1:2 with lines title "Total" lc rgb colour_total, \
 filename using 1:3 with lines title "Critical" lc rgb colour_critical, \
 filename using 1:4 with lines title "High" lc rgb colour_high, \
 filename using 1:5 with lines title "Medium" lc rgb colour_medium, \
 filename using 1:6 with lines title "Low" lc rgb colour_low, \
 filename using 1:7 with lines title "Negligible" lc rgb colour_negligible
EOL
}
plot_open_total_line()
{
	local data="$1"
	local prefix="$2"

	plot_open_total_line_template "black" | gnuplot -p -e "filename=\"$data\"" -e "set title \"$series $source Open (Total)\"" - >"$prefix--open--total--line--light.svg"
	plot_open_total_line_template "white" | gnuplot -p -e "filename=\"$data\"" -e "set title \"$series $source Open (Total)\"" - >"$prefix--open--total--line--dark.svg"
}

plot_open_total_bar_template()
{
	local colour="$1"
	plot_header "$colour"
	cat - <<'EOL'
set grid y
set style fill solid 1.0 border -1
set boxwidth 0.5 relative

plot \
 filename using 1:($2+$3+$4+$5+$6) with boxes title "Critical" lc rgb colour_critical, \
 filename using 1:($3+$4+$5+$6) with boxes title "High" lc rgb colour_high, \
 filename using 1:($4+$5+$6) with boxes title "Medium" lc rgb colour_medium, \
 filename using 1:($5+$6) with boxes title "Low" lc rgb colour_low, \
 filename using 1:6 with boxes title "Negligible" lc rgb colour_negligible, \
 filename using 1:($2+$3+$4+$5+$6):(($2+$3+$4+$5+$6) != 0 ? sprintf("%d", $2+$3+$4+$5+$6) : "") with labels textcolor rgb colour_label offset char 0,0.6 font ",8" rotate notitle
EOL
}
plot_open_total_bar()
{
	local data="$1"
	local prefix="$2"

	plot_open_total_bar_template "black" | gnuplot -p -e "filename=\"$data\"" -e "set title \"$series $source CVEs Opened (Total)\"" - >"$prefix--open--total--bar--light.svg"
	plot_open_total_bar_template "white" | gnuplot -p -e "filename=\"$data\"" -e "set title \"$series $source CVEs Opened (Total)\"" - >"$prefix--open--total--bar--dark.svg"
}

plot_closed_total_line_template()
{
	local colour="$1"
	plot_header "$colour"
	cat - <<'EOL'
plot \
 filename using 1:2 with lines title "Total" lc rgb colour_total, \
 filename using 1:3 with lines title "Critical" lc rgb colour_critical, \
 filename using 1:4 with lines title "High" lc rgb colour_high, \
 filename using 1:5 with lines title "Medium" lc rgb colour_medium, \
 filename using 1:6 with lines title "Low" lc rgb colour_low, \
 filename using 1:7 with lines title "Negligible" lc rgb colour_negligible
EOL
}
plot_closed_total_line()
{
	local data="$1"
	local prefix="$2"

	plot_closed_total_line_template "black" | gnuplot -p -e "filename=\"$data\"" -e "set title \"$series $source Closed (Total)\"" - >"$prefix--closed--total--line--light.svg"
	plot_closed_total_line_template "white" | gnuplot -p -e "filename=\"$data\"" -e "set title \"$series $source Closed (Total)\"" - >"$prefix--closed--total--line--dark.svg"
}

plot_closed_total_bar_template()
{
	local colour="$1"
	plot_header "$colour"
	cat - <<'EOL'
set grid y
set style fill solid 1.0 border -1
set boxwidth 0.5 relative

plot \
 filename using 1:($2+$3+$4+$5+$6) with boxes title "Critical" lc rgb colour_critical, \
 filename using 1:($3+$4+$5+$6) with boxes title "High" lc rgb colour_high, \
 filename using 1:($4+$5+$6) with boxes title "Medium" lc rgb colour_medium, \
 filename using 1:($5+$6) with boxes title "Low" lc rgb colour_low, \
 filename using 1:6 with boxes title "Negligible" lc rgb colour_negligible, \
 filename using 1:($2+$3+$4+$5+$6):(($2+$3+$4+$5+$6) != 0 ? sprintf("%d", $2+$3+$4+$5+$6) : "") with labels textcolor rgb colour_label offset char 0,0.6 font ",8" rotate notitle
EOL
}
plot_closed_total_bar()
{
	local data="$1"
	local prefix="$2"

	plot_closed_total_bar_template "black" | gnuplot -p -e "filename=\"$data\"" -e "set title \"$series $source CVEs Closed (Total)\"" - >"$prefix--closed--total--bar--light.svg"
	plot_closed_total_bar_template "white" | gnuplot -p -e "filename=\"$data\"" -e "set title \"$series $source CVEs Closed (Total)\"" - >"$prefix--closed--total--bar--dark.svg"
}

plot_needswork_total_line_template()
{
	local colour="$1"
	plot_header "$colour"
	cat - <<'EOL'
plot \
 filename using 1:2 with lines title "Total" lc rgb colour_l1, \
 filename using 1:3 with lines title "Needs Work" lc rgb colour_l2
EOL
}
plot_needswork_total_line()
{
	local data="$1"
	local prefix="$2"

	plot_needswork_total_line_template "black" | gnuplot -p -e "filename=\"$data\"" -e "set title \"$series $source Needs Work\"" - >"$prefix--needswork--total--line--light.svg"
	plot_needswork_total_line_template "white" | gnuplot -p -e "filename=\"$data\"" -e "set title \"$series $source Needs Work\"" - >"$prefix--needswork--total--line--dark.svg"
}

plot_open_delta_bar_template()
{
	local colour="$1"
	plot_header "$colour"
	cat - <<'EOL'
set ylabel "CVEs per Month" font ",8"
set grid y
set style fill solid 1.0 border -1
set boxwidth 0.5 relative

plot \
 filename using 1:($2+$3+$4+$5+$6) with boxes title "Critical" lc rgb colour_critical, \
 filename using 1:($3+$4+$5+$6) with boxes title "High" lc rgb colour_high, \
 filename using 1:($4+$5+$6) with boxes title "Medium" lc rgb colour_medium, \
 filename using 1:($5+$6) with boxes title "Low" lc rgb colour_low, \
 filename using 1:6 with boxes title "Negligible" lc rgb colour_negligible, \
 filename using 1:($2+$3+$4+$5+$6):(($2+$3+$4+$5+$6) != 0 ? sprintf("%d", $2+$3+$4+$5+$6) : "") with labels textcolor rgb colour_label offset char 0,0.4 font ",8" notitle
EOL
}
plot_open_delta_bar()
{
	local data="$1"
	local prefix="$2"

	plot_open_delta_bar_template "black" | gnuplot -p -e "filename=\"$data\"" -e "set title \"$series $source CVEs Opened\"" - >"$prefix--open--delta--bar--light.svg"
	plot_open_delta_bar_template "white" | gnuplot -p -e "filename=\"$data\"" -e "set title \"$series $source CVEs Opened\"" - >"$prefix--open--delta--bar--dark.svg"
}

plot_open_hc_delta_bar_template()
{
	local colour="$1"
	plot_header "$colour"
	cat - <<'EOL'
set ylabel "CVEs per Month" font ",8"
set grid y
set style fill solid 1.0 border -1
set boxwidth 0.5 relative

plot \
 filename using 1:($2+$3) with boxes title "Critical" lc rgb colour_critical, \
 filename using 1:3 with boxes title "High" lc rgb colour_high, \
 filename using 1:($2+$3):(($2+$3) != 0 ? sprintf("%d", $2+$3) : "") with labels textcolor rgb colour_label offset char 0,0.4 font ",8" notitle
EOL
}
plot_open_hc_delta_bar()
{
	local data="$1"
	local prefix="$2"

	plot_open_hc_delta_bar_template "black" | gnuplot -p -e "filename=\"$data\"" -e "set title \"$series $source CVEs Opened (High & Critical)\"" - >"$prefix--open-hc--delta--bar--light.svg"
	plot_open_hc_delta_bar_template "white" | gnuplot -p -e "filename=\"$data\"" -e "set title \"$series $source CVEs Opened (High & Critical)\"" - >"$prefix--open-hc--delta--bar--dark.svg"
}

plot_closed_delta_bar_template()
{
	local colour="$1"
	plot_header "$colour"
	cat - <<'EOL'
set ylabel "CVEs per Month" font ",8"
set grid y
set style fill solid 1.0 border -1
set boxwidth 0.5 relative

plot \
 filename using 1:($2+$3+$4+$5+$6) with boxes title "Critical" lc rgb colour_critical, \
 filename using 1:($3+$4+$5+$6) with boxes title "High" lc rgb colour_high, \
 filename using 1:($4+$5+$6) with boxes title "Medium" lc rgb colour_medium, \
 filename using 1:($5+$6) with boxes title "Low" lc rgb colour_low, \
 filename using 1:6 with boxes title "Negligible" lc rgb colour_negligible, \
 filename using 1:($2+$3+$4+$5+$6):(($2+$3+$4+$5+$6) != 0 ? sprintf("%d", $2+$3+$4+$5+$6) : "") with labels textcolor rgb colour_label offset char 0,0.4 font ",8" notitle
EOL
}
plot_closed_delta_bar()
{
	local data="$1"
	local prefix="$2"

	plot_closed_delta_bar_template "black" | gnuplot -p -e "filename=\"$data\"" -e "set title \"$series $source CVEs Closed\"" - >"$prefix--closed--delta--bar--light.svg"
	plot_closed_delta_bar_template "white" | gnuplot -p -e "filename=\"$data\"" -e "set title \"$series $source CVEs Closed\"" - >"$prefix--closed--delta--bar--dark.svg"
}

plot_closed_hc_delta_bar_template()
{
	local colour="$1"
	plot_header "$colour"
	cat - <<'EOL'
set ylabel "CVEs per Month" font ",8"
set grid y
set style fill solid 1.0 border -1
set boxwidth 0.5 relative

plot \
 filename using 1:($2+$3) with boxes title "Critical" lc rgb colour_critical, \
 filename using 1:3 with boxes title "High" lc rgb colour_high, \
 filename using 1:($2+$3):(($2+$3) != 0 ? sprintf("%d", $2+$3) : "") with labels textcolor rgb colour_label offset char 0,0.4 font ",8" notitle
EOL
}
plot_closed_hc_delta_bar()
{
	local data="$1"
	local prefix="$2"

	plot_closed_hc_delta_bar_template "black" | gnuplot -p -e "filename=\"$data\"" -e "set title \"$series $source CVEs Closed (High & Critical)\"" - >"$prefix--closed-hc--delta--bar--light.svg"
	plot_closed_hc_delta_bar_template "white" | gnuplot -p -e "filename=\"$data\"" -e "set title \"$series $source CVEs Closed (High & Critical)\"" - >"$prefix--closed-hc--delta--bar--dark.svg"
}

while read series source
do
	echo "$series $source ..."
	prefix=$( echo "$series--$source" | sed -e 's#/#@#' )

	"$here/kpi-cve-graph" "open" "$series" "$source" *.json >"$plot"
	# Last entry in precise is just junk :<
	case "$series--$source" in
	precise--linux)
		<"$plot" grep -v '^2017-05-29 ' >"$plot.new"
		mv "$plot.new" "$plot"
		;;
	esac
	plot_open_total_line "$plot" "$out/$prefix"
	plot_open_total_bar "$plot" "$out/$prefix"

	"$here/kpi-cve-graph" "closed" "$series" "$source" *.json >"$plot"
	# Last entry in precise is just junk :<
	case "$series--$source" in
	precise--linux)
		<"$plot" grep -v '^2017-05-29 ' >"$plot.new"
		mv "$plot.new" "$plot"
		;;
	esac
	plot_closed_total_line "$plot" "$out/$prefix"
	plot_closed_total_bar "$plot" "$out/$prefix"

	"$here/kpi-cve-graph" "needswork" "$series" "$source" *.json >"$plot"
	plot_needswork_total_line "$plot" "$out/$prefix"

	"$here/kpi-cve-graph" "open-delta" "$series" "$source" *.json >"$plot"
	#echo "v-- APW"
	#cat "$plot"
	#echo "^-- APW"
	plot_open_delta_bar "$plot" "$out/$prefix"
	plot_open_hc_delta_bar "$plot" "$out/$prefix"

	"$here/kpi-cve-graph" "closed-delta" "$series" "$source" *.json >"$plot"
	plot_closed_delta_bar "$plot" "$out/$prefix"
	plot_closed_hc_delta_bar "$plot" "$out/$prefix"
done <<EOL
lucid linux
precise linux
precise/esm linux
trusty linux
vivid/ubuntu-core linux
xenial linux
zesty linux
EOL

rm -f "$plot"
