#!/bin/bash

here=`dirname $0`
case "$here" in
/*) ;;
*)  here="`pwd`/$here" ;;
esac

if [ "$#" -ne 1 ]; then
	echo "Usage: $0 <output directory>" 1>&2
	exit 1
fi
out="$1"

plot="/tmp/plot.$$"

plot_totals_template()
{
	cat - <<'EOL'
set xdata time
set timefmt "%Y-%m-%d"
set format x "%Y-%m-%d"

set terminal jpeg

set key top left box

set xtics rotate 

plot \
 filename using 1:2 with lines title "Total", \
 filename using 1:3 with lines title "Critical", \
 filename using 1:4 with lines title "High", \
 filename using 1:5 with lines title "Medium", \
 filename using 1:6 with lines title "Low", \
 filename using 1:7 with lines title "Negligible"
EOL
}
plot_totals()
{
	local data="$1"
	local prefix="$2"

	plot_totals_template | gnuplot -p -e "filename=\"$data\"" -e "set title \"$series $source Totals\"" - >"$prefix-totals.jpeg"
}

while read series source
do
	"$here/kpi-cve-graph" "$series" "$source" *.json >"$plot"

	# Last entry in precise is just junk :<
	case "$series--$source" in
	precise--linux)
		<"$plot" grep -v '^2017-05-29 ' >"$plot.new"
		mv "$plot.new" "$plot"
		;;
	esac

	prefix=$( echo "$series-$source" | sed -e 's#/#@#' )
	plot_totals "$plot" "$out/$prefix"
done <<EOL
lucid linux
precise linux
precise/esm linux
trusty linux
xenial linux
yakkety linux
zesty linux
EOL

rm -f "$plot"
