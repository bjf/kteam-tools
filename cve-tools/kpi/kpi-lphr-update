#!/bin/bash

here=`dirname $0`
case "$here" in
/*) ;;
*)  here="`pwd`/$here" ;;
esac

if [ "$#" != 1 ]; then
    echo "Usage: $0 <number of days>" 1>&2
    exit 1
fi
count="$1"

# Though we start take todays midnight we will always reverse one day before
# doing a lookup.  This is because _today_ by definition is not complete.
date=$( date --date "today 00:00:00" +%Y-%m-%d )

url='https://livepatch.canonical.com:335/api/restricted/health-report?num_hours=24&start_date='

while [ "$count" -gt 0 ]
do
    let "count=$count - 1"
    date=$( date --date "$date - 24 hours" +%Y-%m-%d )

    stats="$date.24h"
    day_url="${url}${date}-00-00"

    if [ -f "$stats" ]; then
        size=$( wc -c <"$stats" )
        if [ "$size" != 92 -a "$size" != 0 ]; then
            continue
        fi
    fi

    echo "$date ..." 1>&2
    curl "$day_url" >"$stats"

    size=$( wc -c <"$stats" )
    if [ "$size" = 92 -o "$size" = 0 ]; then
        echo "*** TIMEOUT ..."
        rm "$stats"
        continue
    fi

    "$here/kpi-lphr-extract" "$stats" "$date"
done >livepatch.influx
curl --netrc-file $HOME/.influx-kernel.auth -i -XPOST 'http://influxdb.cloud.kpi.internal:8086/write?db=kernel' --data-binary '@livepatch.influx'
