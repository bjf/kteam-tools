#!/bin/bash

case "$1" in
daily)
	date_target=`date --date "today" +%Y-%m-%d`
	date_range='4 years'
	date_step='1 day'
	;;
weekly)
	date_target=`date --date "12pm last sunday + 24 hours" +%Y-%m-%d`
	date_range='4 years'
	date_step='1 week'
	;;
monthly)
	date_target=`date --date "today" +%Y-%m`-01
	date_range='4 years'
	date_step='1 month'
	;;
esac

date_stop=`date --date "$date_target - $date_range" +%Y-%m-%d`
bzr log --line | sed -e 's/^\([0-9][0-9]*\):.*\s\([0-9][0-9][0-9][0-9]-[0-9][0-9]-[0-9][0-9]\)\s.*/\1 \2/' | \
while read id date
do
	#echo "id<$id> date<$date> date_target<$date_target> date_stop<$date_stop>"

	if [ "$date_target" \< "$date_stop" ]; then
		break
	fi

	if [ "$date_target" \< "$date" ]; then
		continue
	fi
	while ! [ "$date_target" \< "$date" ]; do
		##echo "FOUND $id $date $date_target"
		echo "$id" "$date_target"

		date_target=`date --date "$date_target - $date_step" +%Y-%m-%d`
	done
done | tac | \
{
	# We only want the oldest date which has this version in it.
	id_prev=''
	while read id date
	do
		[ "$id_prev" = "$id" ] && continue
		id_prev="$id"

		echo "$id $date"
	done
} | tac
