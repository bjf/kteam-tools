#!/bin/bash

here=`dirname $0`
case "$here" in
/*) ;;
*)  here="`pwd`/$here" ;;
esac

config="$1"
devel="$2"
shift 2

while read series cvebranch repo branch flags X
do
	from=",${flags},"
	from="${from#*,metaonly-link:}"
	from="${from%%,*}"
	[ "$from" = "" ] && continue

	to_series=$(echo "$series" | sed -e "s/^${devel}\$/devel/")
	to="${to_series}_${cvebranch}"

	echo "transfer $from -> $to" 1>&2
	grep -H "^$from:" "$@" | \
		sed -e 's/:/ /' | \
		while read file dummy state notes
		do
			[ "$notes" = '' ] && notes="-"
			notes=$(echo "$notes" | sed -e 's/^(//' -e 's/)$//')
			case "$state" in
			pending|needed|released|not-affected)
				echo "$file $to_series $cvebranch - $state $notes"
				;;
			esac
		done
done <"$config" | "$here/cves-tracker-update2" "$devel"
