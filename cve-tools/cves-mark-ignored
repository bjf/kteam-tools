#!/bin/bash

here=`dirname $0`
case "$here" in
/*) ;;
*)  here="`pwd`/$here" ;;
esac

if [ "$#" -lt 2 ]; then
	echo "Usage: $0 <config> <devel release> <cves>" 1>&2
	exit 1
fi
config="$1"
devel="$2"
shift 2

while read series cvebranch repo branch flags X
do
	case ",$flags," in
	*,mark-ignored,*)	;;
	*)			continue ;;
	esac

	mim=",${flags},"
	mim="${mim#*,mark-ignored-message:}"
	mim="${mim%%,*}"
	[ "$mim" != "" ] && mim=" ${mim}"
	mim=`echo "$mim" | sed -e 's/%s/ /g' -e 's/%%/%/g'`

	echo "$series $cvebranch (ignored$mim) ..."

	if [ "$series" = "$devel" ]; then
		series="devel"
	fi

	# You used a / ...
	series_sed="${series//\//\\/}"

	egrep -H "^${series}_${cvebranch}: *(needs-triage|needed|pending|deferred)" "$@" |\
	while IFS=: read cve series_branch state
	do
		#echo ">$cve< >$series_branch< >$state<"
		echo "$cve $series $cvebranch $cve marked ignored$mim"
		sed "$cve" -i \
			-e "/\(^${series_sed}_${cvebranch}:\) *\(needs-triage.*\|needed.*\|pending.*$\)/ {" \
			-e "s/(/[/g" \
			-e "s/)/]/g" \
			-e "s/\(^${series_sed}_${cvebranch}:\) *\(needs-triage.*\|needed.*\|pending.*$\)/\1 ignored (was \2$mim)/" \
			-e "}"
	done
done <"$config"
