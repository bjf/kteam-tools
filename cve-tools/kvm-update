#!/bin/bash

here=`dirname $0`
case "$here" in
/*) ;;
*)  here="`pwd`/$here" ;;
esac

# Make sure we are only run once ...

[ "$1" != "--locked" ] && exec flock -xn "$HOME/logs/.lock-kvm-update" "$0" --locked "$@"

(
	cd "$HOME/cve-autotriage" || exit 1
	"$here/cves-kernel-versions-map" "$here/cves-autotriage.conf" $HOME/cve-autotriage/state \
		"$HOME/public_html/info/kernel-version-map.html.new" \
		"$HOME/public_html/info/kernel-version-map.txt.new"
	mv -f "$HOME/public_html/info/kernel-version-map.html.new" "$HOME/public_html/info/kernel-version-map.html"
	mv -f "$HOME/public_html/info/kernel-version-map.txt.new" "$HOME/public_html/info/kernel-version-map.txt"
) >"$HOME/logs/kvm-update.log" 2>&1
