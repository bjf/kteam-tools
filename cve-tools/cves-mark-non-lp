#!/bin/bash

here=`dirname $0`
case "$here" in
/*) ;;
*)  here="`pwd`/$here" ;;
esac

if [ "$#" -lt 2 ]; then
	echo "Usage: $0 <config> <devel release> <cves>" 1>&2
	exit 1
fi
config="$1"
devel="$2"
shift 2

while read series cvebranch repo branch flags X
do
	case ",$flags," in
	*,mark-nonlp,*)		;;
	*)			continue ;;
	esac

	mim=",${flags},"
	mim="${mim#*,mark-nonlp-message:}"
	mim="${mim%%,*}"
	[ "$mim" != "" ] && mim=" ${mim}"
	mim=`echo "$mim" | sed -e 's/%s/ /g' -e 's/%%/%/g'`

	final_version=",${flags},"
	final_version="${final_version#*,mark-nonlp-version:}"
	final_version="${final_version%%,*}"

	echo "$series $cvebranch (ignored$mim) final_version:$final_version ..."

	if [ "$series" = "$devel" ]; then
		series="devel"
	fi

	egrep -H "^${series}_${cvebranch}: *pending *\(" "$@" |\
	while IFS=: read cve series_branch state
	do
                version=`echo "$state" | sed -e 's/.*(//' -e 's/)//'`
                if [ "$final_version" != "" ] && \
                                dpkg --compare-versions "$version" le "$final_version"; then
			continue
		fi

		#echo ">$cve< >$series_branch< >$state<"
		echo "$cve $series $cvebranch $cve marked ignored$mim"
		sed "$cve" -i \
			-e "/\(^${series}_${cvebranch}:\) *\(pending.*\)/ {" \
			-e "s/(/[/g" \
			-e "s/)/]/g" \
			-e "s/\(^${series}_${cvebranch}:\) *\(pending.*\)/\1 ignored (was \2$mim)/" \
			-e "}"
	done
done <"$config"
