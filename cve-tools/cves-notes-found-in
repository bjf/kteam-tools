#!/bin/bash

config="$1"
devel="$2"
cve_list="$3"
shift 3

while read series cvebranch repo branch flags X
do
	tos=",${flags},"
	tos="${tos#*,transfer-pending:}"
	tos="${tos%%,*}"
	tos="${tos//\// }"
	[ "$tos" = "" ] && continue

	tom=",${flags},"
	tom="${tom#*,transfer-message:}"
	tom="${tom%%,*}"
	[ "$tom" = "" ] && tom="in stable"

	tot=",${flags},"
	tot="${tot#*,transfer-message-tip:}"
	tot="${tot%%,*}"
	[ "$tot" = "" ] && tot="$tom"

	echo "transfer pending ${series}_${cvebranch} -> $tos" 1>&2

	grep " ${series} ${cvebranch} " "$cve_list" |
		while read file d1 d2 d3 state version
		do
			file="${file##*/}"
			case "$state" in
			needed|not-affected)	;;
			*)
				if [ "$version" = 'pending' ]; then
					msg="$tot"
				else
					msg="$tom"
				fi
				msg="${msg//\%v/$version}"
				for to in $tos
				do
					to="${to//_/ }"
					echo "$file $to needed $msg"
				done
				;;
			esac
		done
done <"$config"
