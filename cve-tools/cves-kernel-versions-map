#!/bin/bash

here=`dirname $0`
case "$here" in
/*) ;;
*)  here="`pwd`/$here" ;;
esac

repos="$HOME/cve-autotriage"

work="$1"
cache="$2"
html="$3"
txt="$4"

tag_cache="$cache/tag"
mkdir -p "$tag_cache"

: >"$txt"
cat - >"$html" <<EOM
<html>
<head>
<title>Ubuntu to Mainline kernel version mapping</title>
</head>
<body>
EOM
while read series cvebranch repo branch flags X
do
	case ",$flags," in
	*,scan,*)		;;
	*)			continue;;
	esac

	echo "*** checking $series $cvebranch ... " 1>&2
	case "$series" in
	upstream|product)		continue;;
	esac

	(
		cd "$repos/$repo" || exit 1

		"$here/cves-git-tags-versions" versions "$tag_cache" "$cvebranch" \
			$("$here/cves-kernel-versions" "tags" "$series" "$cvebranch") | \
		{
			cat - >>"$html" <<EOM
<h2>$series $cvebranch</h2>
<table border="1">
<tr><th>Ubuntu Kernel Version<th>Ubuntu Kernel Tag<th>Mainline Kernel Version</tr>
EOM
			while read version tag kver
			do
				echo "<tr><td>$version<td>$tag<td>$kver</tr>" >>"$html"
				echo "$series $cvebranch $version $tag $kver" >>"$txt"
			done
			echo "</table>" >>"$html"
		}
	)
done <"$work"
cat - >>"$html" <<EOM
</body>
</html>
EOM
